5cd1c13564a7bca718f86d25eaf6e9c2
'use strict';

jest.mock('lib/binary-stream');

const reserved = require('types/reserved');
const when = require('types/when');
const { decode } = require('lib/decode');

describe('decode', () => {
  test('should use schema', () => {
    const rstream = {};
    const bytes = 10;

    const res1 = 100;
    const res2 = 200;

    const schema = {
      a: {
        decode: () => res1
      },
      b: {
        decode: () => res2
      }
    };

    schema.a.decode.bytes = bytes;
    schema.b.decode.bytes = bytes;

    const expectedResult = {
      a: res1,
      b: res2
    };

    const result = decode(rstream, schema);
    expect(result).toEqual(expectedResult);
    expect(decode.bytes).toEqual(bytes * 2);
  });

  test('should skip reserved field', () => {
    const rstream = {};
    const bytes = 10;
    const res1 = 100;
    const res2 = 200;

    const type1 = {
      decode: () => res1
    };

    const type2 = {
      decode: () => res2,
      encode() {}
    };

    type1.decode.bytes = bytes;
    type2.decode.bytes = bytes;

    const schema = {
      a: type1,
      b: reserved(type2, 1)
    };

    const expectedResult = {
      a: res1
    };

    const result = decode(rstream, schema);
    expect(result).toEqual(expectedResult);
    expect(decode.bytes).toEqual(bytes * 2);
  });

  test('should set context', () => {
    const rstream = {};
    let called = false;

    const schema = {
      a: {
        decode: xdecode
      }
    };

    function xdecode(rstream_) {
      expect(rstream_).toBe(rstream);
      // eslint-disable-next-line no-invalid-this
      const context = this;

      expect(context).toHaveProperty('node', {});
      expect(context).toHaveProperty('current', {});
      called = true;
    }

    decode(rstream, schema);
    expect(called).toBeTruthy();
  });

  test('schema should be a plain object', () => {
    const rstream = {};
    const expectedError = 'Argument #2 should be a plain object.';

    expect(() => decode(rstream, 123)).toThrow(expectedError);
    expect(() => decode(rstream, '123')).toThrow(expectedError);
    expect(() => decode(rstream, /.+/)).toThrow(expectedError);
  });

  test('each field should have a valid type', () => {
    const rstream = {};

    const schema = {
      a: null
    };

    const expectedError = `Argument #2 should be a plain object.`;

    expect(() => decode(rstream, schema)).toThrow(expectedError);
  });

  test('should decode nested types', () => {
    const rstream = {};
    const res1 = 100;
    const bytes = 10;

    const schema = {
      a: {
        b: {
          decode: () => res1
        }
      },
      c: {
        decode: () => res1
      }
    };

    schema.a.b.decode.bytes = bytes;
    schema.c.decode.bytes = bytes;

    const expectedResult = {
      a: {
        b: res1
      },
      c: res1
    };

    const result = decode(rstream, schema);
    expect(result).toEqual(expectedResult);
    expect(decode.bytes).toEqual(bytes * 2);
  });

  test('should decode buffers', () => {
    const buffer = Buffer.alloc(1);
    const bytes = 10;
    const res1 = 100;

    const schema = {
      a: {
        decode: () => res1
      }
    };

    schema.a.decode.bytes = bytes;

    const expectedResult = {
      a: res1
    };

    const result = decode(buffer, schema);

    expect(result).toEqual(expectedResult);
    expect(decode.bytes).toEqual(bytes);
  });

  test('should decode positive conditions', () => {
    const rstream = {};
    const bytes = 10;

    const res1 = 100;
    const res2 = 200;

    const type1 = {
      decode: () => res1
    };

    const type2 = {
      decode: () => res2,
      encode() {}
    };

    type1.decode.bytes = bytes;
    type2.decode.bytes = bytes;

    const schema = {
      a: type1,
      b: when(() => true, type2)
    };

    const expectedResult = {
      a: res1,
      b: res2
    };

    const result = decode(rstream, schema);

    expect(result).toEqual(expectedResult);
    expect(decode.bytes).toEqual(bytes * 2);
  });

  test('should skip negative conditions', () => {
    const rstream = {};
    const bytes = 10;

    const res1 = 100;
    const res2 = 200;

    const type1 = {
      decode: () => res1
    };

    const type2 = {
      decode: () => res2,
      encode() {}
    };

    type1.decode.bytes = bytes;
    type2.decode.bytes = bytes;

    const schema = {
      a: type1,
      b: when(() => false, type2)
    };

    const expectedResult = {
      a: res1
    };

    const result = decode(rstream, schema);

    expect(result).toEqual(expectedResult);
    expect(decode.bytes).toEqual(bytes);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRlY29kZS5qcyJdLCJuYW1lcyI6WyJqZXN0IiwibW9jayIsInJlc2VydmVkIiwicmVxdWlyZSIsIndoZW4iLCJkZWNvZGUiLCJkZXNjcmliZSIsInRlc3QiLCJyc3RyZWFtIiwiYnl0ZXMiLCJyZXMxIiwicmVzMiIsInNjaGVtYSIsImEiLCJiIiwiZXhwZWN0ZWRSZXN1bHQiLCJyZXN1bHQiLCJleHBlY3QiLCJ0b0VxdWFsIiwidHlwZTEiLCJ0eXBlMiIsImVuY29kZSIsImNhbGxlZCIsInhkZWNvZGUiLCJyc3RyZWFtXyIsInRvQmUiLCJjb250ZXh0IiwidG9IYXZlUHJvcGVydHkiLCJ0b0JlVHJ1dGh5IiwiZXhwZWN0ZWRFcnJvciIsInRvVGhyb3ciLCJjIiwiYnVmZmVyIiwiQnVmZmVyIiwiYWxsb2MiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxLQUFLQyxJQUFMLENBQVUsbUJBQVY7O0FBRUEsTUFBTUMsV0FBV0MsUUFBUSxnQkFBUixDQUFqQjtBQUNBLE1BQU1DLE9BQU9ELFFBQVEsWUFBUixDQUFiO0FBQ0EsTUFBTSxFQUFFRSxNQUFGLEtBQWFGLFFBQVEsWUFBUixDQUFuQjs7QUFFQUcsU0FBUyxRQUFULEVBQW1CLE1BQU07QUFDdkJDLE9BQUssbUJBQUwsRUFBMEIsTUFBTTtBQUM5QixVQUFNQyxVQUFVLEVBQWhCO0FBQ0EsVUFBTUMsUUFBUSxFQUFkOztBQUVBLFVBQU1DLE9BQU8sR0FBYjtBQUNBLFVBQU1DLE9BQU8sR0FBYjs7QUFFQSxVQUFNQyxTQUFTO0FBQ2JDLFNBQUc7QUFDRFIsZ0JBQVEsTUFBTUs7QUFEYixPQURVO0FBSWJJLFNBQUc7QUFDRFQsZ0JBQVEsTUFBTU07QUFEYjtBQUpVLEtBQWY7O0FBU0FDLFdBQU9DLENBQVAsQ0FBU1IsTUFBVCxDQUFnQkksS0FBaEIsR0FBd0JBLEtBQXhCO0FBQ0FHLFdBQU9FLENBQVAsQ0FBU1QsTUFBVCxDQUFnQkksS0FBaEIsR0FBd0JBLEtBQXhCOztBQUVBLFVBQU1NLGlCQUFpQjtBQUNy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ckI7QUFDQVcsVUFBTWYsTUFBTixDQUFhSSxLQUFiLEdBQXFCQSxLQUFyQjs7QUFFQSxVQUFNRyxTQUFTO0FBQ2JDLFNBQUdNLEtBRFU7QUFFYkwsU0FBR1YsS0FBSyxNQUFNLEtBQVgsRUFBa0JnQixLQUFsQjtBQUZVLEtBQWY7O0FBS0EsVUFBTUwsaUJBQWlCO0FBQ3JCRixTQUFHSDtBQURrQixLQUF2Qjs7QUFJQSxVQUFNTSxTQUFTWCxPQUFPRyxPQUFQLEVBQWdCSSxNQUFoQixDQUFmOztBQUVBSyxXQUFPRCxNQUFQLEVBQWVFLE9BQWYsQ0FBdUJILGNBQXZCO0FBQ0FFLFdBQU9aLE9BQU9JLEtBQWQsRUFBcUJTLE9BQXJCLENBQTZCVCxLQUE3QjtBQUNELEdBaENEO0FBaUNELENBck9EIiwiZmlsZSI6ImRlY29kZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuamVzdC5tb2NrKCdsaWIvYmluYXJ5LXN0cmVhbScpO1xuXG5jb25zdCByZXNlcnZlZCA9IHJlcXVpcmUoJ3R5cGVzL3Jlc2VydmVkJyk7XG5jb25zdCB3aGVuID0gcmVxdWlyZSgndHlwZXMvd2hlbicpO1xuY29uc3QgeyBkZWNvZGUgfSA9IHJlcXVpcmUoJ2xpYi9kZWNvZGUnKTtcblxuZGVzY3JpYmUoJ2RlY29kZScsICgpID0+IHtcbiAgdGVzdCgnc2hvdWxkIHVzZSBzY2hlbWEnLCAoKSA9PiB7XG4gICAgY29uc3QgcnN0cmVhbSA9IHt9O1xuICAgIGNvbnN0IGJ5dGVzID0gMTA7XG5cbiAgICBjb25zdCByZXMxID0gMTAwO1xuICAgIGNvbnN0IHJlczIgPSAyMDA7XG5cbiAgICBjb25zdCBzY2hlbWEgPSB7XG4gICAgICBhOiB7XG4gICAgICAgIGRlY29kZTogKCkgPT4gcmVzMSxcbiAgICAgIH0sXG4gICAgICBiOiB7XG4gICAgICAgIGRlY29kZTogKCkgPT4gcmVzMixcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHNjaGVtYS5hLmRlY29kZS5ieXRlcyA9IGJ5dGVzO1xuICAgIHNjaGVtYS5iLmRlY29kZS5ieXRlcyA9IGJ5dGVzO1xuXG4gICAgY29uc3QgZXhwZWN0ZWRSZXN1bHQgPSB7XG4gICAgICBhOiByZXMxLFxuICAgICAgYjogcmVzMixcbiAgICB9O1xuXG4gICAgY29uc3QgcmVzdWx0ID0gZGVjb2RlKHJzdHJlYW0sIHNjaGVtYSk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChleHBlY3RlZFJlc3VsdCk7XG4gICAgZXhwZWN0KGRlY29kZS5ieXRlcykudG9FcXVhbChieXRlcyAqIDIpO1xuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgc2tpcCByZXNlcnZlZCBmaWVsZCcsICgpID0+IHtcbiAgICBjb25zdCByc3RyZWFtID0ge307XG4gICAgY29uc3QgYnl0ZXMgPSAxMDtcbiAgICBjb25zdCByZXMxID0gMTAwO1xuICAgIGNvbnN0IHJlczIgPSAyMDA7XG5cbiAgICBjb25zdCB0eXBlMSA9IHtcbiAgICAgIGRlY29kZTogKCkgPT4gcmVzMSxcbiAgICB9O1xuXG4gICAgY29uc3QgdHlwZTIgPSB7XG4gICAgICBkZWNvZGU6ICgpID0+IHJlczIsXG4gICAgICBlbmNvZGUoKSB7fSxcbiAgICB9O1xuXG4gICAgdHlwZTEuZGVjb2RlLmJ5dGVzID0gYnl0ZXM7XG4gICAgdHlwZTIuZGVjb2RlLmJ5dGVzID0gYnl0ZXM7XG5cbiAgICBjb25zdCBzY2hlbWEgPSB7XG4gICAgICBhOiB0eXBlMSxcbiAgICAgIGI6IHJlc2VydmVkKHR5cGUyLCAxKSxcbiAgICB9O1xuXG4gICAgY29uc3QgZXhwZWN0ZWRSZXN1bHQgPSB7XG4gICAgICBhOiByZXMxLFxuICAgIH07XG5cbiAgICBjb25zdCByZXN1bHQgPSBkZWNvZGUocnN0cmVhbSwgc2NoZW1hKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGV4cGVjdGVkUmVzdWx0KTtcbiAgICBleHBlY3QoZGVjb2RlLmJ5dGVzKS50b0VxdWFsKGJ5dGVzICogMik7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBzZXQgY29udGV4dCcsICgpID0+IHtcbiAgICBjb25zdCByc3RyZWFtID0ge307XG4gICAgbGV0IGNhbGxlZCA9IGZhbHNlO1xuXG4gICAgY29uc3Qgc2NoZW1hID0ge1xuICAgICAgYToge1xuICAgICAgICBkZWNvZGU6IHhkZWNvZGUsXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBmdW5jdGlvbiB4ZGVjb2RlKHJzdHJlYW1fKSB7XG4gICAgICBleHBlY3QocnN0cmVhbV8pLnRvQmUocnN0cmVhbSk7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8taW52YWxpZC10aGlzXG4gICAgICBjb25zdCBjb250ZXh0ID0gdGhpcztcblxuICAgICAgZXhwZWN0KGNvbnRleHQpLnRvSGF2ZVByb3BlcnR5KCdub2RlJywge30pO1xuICAgICAgZXhwZWN0KGNvbnRleHQpLnRvSGF2ZVByb3BlcnR5KCdjdXJyZW50Jywge30pO1xuICAgICAgY2FsbGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBkZWNvZGUocnN0cmVhbSwgc2NoZW1hKTtcbiAgICBleHBlY3QoY2FsbGVkKS50b0JlVHJ1dGh5KCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NjaGVtYSBzaG91bGQgYmUgYSBwbGFpbiBvYmplY3QnLCAoKSA9PiB7XG4gICAgY29uc3QgcnN0cmVhbSA9IHt9O1xuICAgIGNvbnN0IGV4cGVjdGVkRXJyb3IgPSAnQXJndW1lbnQgIzIgc2hvdWxkIGJlIGEgcGxhaW4gb2JqZWN0Lic7XG5cbiAgICBleHBlY3QoKCkgPT4gZGVjb2RlKHJzdHJlYW0sIDEyMykpLnRvVGhyb3coZXhwZWN0ZWRFcnJvcik7XG4gICAgZXhwZWN0KCgpID0+IGRlY29kZShyc3RyZWFtLCAnMTIzJykpLnRvVGhyb3coZXhwZWN0ZWRFcnJvcik7XG4gICAgZXhwZWN0KCgpID0+IGRlY29kZShyc3RyZWFtLCAvLisvKSkudG9UaHJvdyhleHBlY3RlZEVycm9yKTtcbiAgfSk7XG5cbiAgdGVzdCgnZWFjaCBmaWVsZCBzaG91bGQgaGF2ZSBhIHZhbGlkIHR5cGUnLCAoKSA9PiB7XG4gICAgY29uc3QgcnN0cmVhbSA9IHt9O1xuXG4gICAgY29uc3Qgc2NoZW1hID0ge1xuICAgICAgYTogbnVsbCxcbiAgICB9O1xuXG4gICAgY29uc3QgZXhwZWN0ZWRFcnJvciA9IGBBcmd1bWVudCAjMiBzaG91bGQgYmUgYSBwbGFpbiBvYmplY3QuYDtcblxuICAgIGV4cGVjdCgoKSA9PiBkZWNvZGUocnN0cmVhbSwgc2NoZW1hKSkudG9UaHJvdyhleHBlY3RlZEVycm9yKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIGRlY29kZSBuZXN0ZWQgdHlwZXMnLCAoKSA9PiB7XG4gICAgY29uc3QgcnN0cmVhbSA9IHt9O1xuICAgIGNvbnN0IHJlczEgPSAxMDA7XG4gICAgY29uc3QgYnl0ZXMgPSAxMDtcblxuICAgIGNvbnN0IHNjaGVtYSA9IHtcbiAgICAgIGE6IHtcbiAgICAgICAgYjoge1xuICAgICAgICAgIGRlY29kZTogKCkgPT4gcmVzMSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBjOiB7XG4gICAgICAgIGRlY29kZTogKCkgPT4gcmVzMSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHNjaGVtYS5hLmIuZGVjb2RlLmJ5dGVzID0gYnl0ZXM7XG4gICAgc2NoZW1hLmMuZGVjb2RlLmJ5dGVzID0gYnl0ZXM7XG5cbiAgICBjb25zdCBleHBlY3RlZFJlc3VsdCA9IHtcbiAgICAgIGE6IHtcbiAgICAgICAgYjogcmVzMSxcbiAgICAgIH0sXG4gICAgICBjOiByZXMxLFxuICAgIH07XG5cbiAgICBjb25zdCByZXN1bHQgPSBkZWNvZGUocnN0cmVhbSwgc2NoZW1hKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGV4cGVjdGVkUmVzdWx0KTtcbiAgICBleHBlY3QoZGVjb2RlLmJ5dGVzKS50b0VxdWFsKGJ5dGVzICogMik7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBkZWNvZGUgYnVmZmVycycsICgpID0+IHtcbiAgICBjb25zdCBidWZmZXIgPSBCdWZmZXIuYWxsb2MoMSk7XG4gICAgY29uc3QgYnl0ZXMgPSAxMDtcbiAgICBjb25zdCByZXMxID0gMTAwO1xuXG4gICAgY29uc3Qgc2NoZW1hID0ge1xuICAgICAgYToge1xuICAgICAgICBkZWNvZGU6ICgpID0+IHJlczEsXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBzY2hlbWEuYS5kZWNvZGUuYnl0ZXMgPSBieXRlcztcblxuICAgIGNvbnN0IGV4cGVjdGVkUmVzdWx0ID0ge1xuICAgICAgYTogcmVzMSxcbiAgICB9O1xuXG4gICAgY29uc3QgcmVzdWx0ID0gZGVjb2RlKGJ1ZmZlciwgc2NoZW1hKTtcblxuICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoZXhwZWN0ZWRSZXN1bHQpO1xuICAgIGV4cGVjdChkZWNvZGUuYnl0ZXMpLnRvRXF1YWwoYnl0ZXMpO1xuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgZGVjb2RlIHBvc2l0aXZlIGNvbmRpdGlvbnMnLCAoKSA9PiB7XG4gICAgY29uc3QgcnN0cmVhbSA9IHt9O1xuICAgIGNvbnN0IGJ5dGVzID0gMTA7XG5cbiAgICBjb25zdCByZXMxID0gMTAwO1xuICAgIGNvbnN0IHJlczIgPSAyMDA7XG5cbiAgICBjb25zdCB0eXBlMSA9IHtcbiAgICAgIGRlY29kZTogKCkgPT4gcmVzMSxcbiAgICB9O1xuXG4gICAgY29uc3QgdHlwZTIgPSB7XG4gICAgICBkZWNvZGU6ICgpID0+IHJlczIsXG4gICAgICBlbmNvZGUoKSB7fSxcbiAgICB9O1xuXG4gICAgdHlwZTEuZGVjb2RlLmJ5dGVzID0gYnl0ZXM7XG4gICAgdHlwZTIuZGVjb2RlLmJ5dGVzID0gYnl0ZXM7XG5cbiAgICBjb25zdCBzY2hlbWEgPSB7XG4gICAgICBhOiB0eXBlMSxcbiAgICAgIGI6IHdoZW4oKCkgPT4gdHJ1ZSwgdHlwZTIpLFxuICAgIH07XG5cbiAgICBjb25zdCBleHBlY3RlZFJlc3VsdCA9IHtcbiAgICAgIGE6IHJlczEsXG4gICAgICBiOiByZXMyLFxuICAgIH07XG5cbiAgICBjb25zdCByZXN1bHQgPSBkZWNvZGUocnN0cmVhbSwgc2NoZW1hKTtcblxuICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoZXhwZWN0ZWRSZXN1bHQpO1xuICAgIGV4cGVjdChkZWNvZGUuYnl0ZXMpLnRvRXF1YWwoYnl0ZXMgKiAyKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHNraXAgbmVnYXRpdmUgY29uZGl0aW9ucycsICgpID0+IHtcbiAgICBjb25zdCByc3RyZWFtID0ge307XG4gICAgY29uc3QgYnl0ZXMgPSAxMDtcblxuICAgIGNvbnN0IHJlczEgPSAxMDA7XG4gICAgY29uc3QgcmVzMiA9IDIwMDtcblxuICAgIGNvbnN0IHR5cGUxID0ge1xuICAgICAgZGVjb2RlOiAoKSA9PiByZXMxLFxuICAgIH07XG5cbiAgICBjb25zdCB0eXBlMiA9IHtcbiAgICAgIGRlY29kZTogKCkgPT4gcmVzMixcbiAgICAgIGVuY29kZSgpIHt9LFxuICAgIH07XG5cbiAgICB0eXBlMS5kZWNvZGUuYnl0ZXMgPSBieXRlcztcbiAgICB0eXBlMi5kZWNvZGUuYnl0ZXMgPSBieXRlcztcblxuICAgIGNvbnN0IHNjaGVtYSA9IHtcbiAgICAgIGE6IHR5cGUxLFxuICAgICAgYjogd2hlbigoKSA9PiBmYWxzZSwgdHlwZTIpLFxuICAgIH07XG5cbiAgICBjb25zdCBleHBlY3RlZFJlc3VsdCA9IHtcbiAgICAgIGE6IHJlczEsXG4gICAgfTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGRlY29kZShyc3RyZWFtLCBzY2hlbWEpO1xuXG4gICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChleHBlY3RlZFJlc3VsdCk7XG4gICAgZXhwZWN0KGRlY29kZS5ieXRlcykudG9FcXVhbChieXRlcyk7XG4gIH0pO1xufSk7XG4iXX0=