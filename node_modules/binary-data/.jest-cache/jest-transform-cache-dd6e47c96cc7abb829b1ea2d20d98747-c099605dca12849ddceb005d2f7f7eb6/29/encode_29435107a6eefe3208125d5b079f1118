bd1a395f41d140dc0eb027041b3bb19f
'use strict';

const reserved = require('types/reserved');
const { encode } = require('lib/encode');
const BinaryStream = require('lib/binary-stream');

describe('encode', () => {
  test('should encode objects using schema', () => {
    const wstream = new BinaryStream();

    const schema = {
      a: {
        encode: jest.fn()
      },
      b: {
        encode: jest.fn()
      }
    };

    const object = {
      a: 100,
      b: 200
    };

    schema.a.encode.bytes = 10;
    schema.b.encode.bytes = 33;

    const res = encode(object, wstream, schema);

    expect(schema.a.encode).toHaveBeenCalledTimes(1);
    expect(schema.b.encode).toHaveBeenCalledTimes(1);
    expect(encode.bytes).toEqual(schema.a.encode.bytes + schema.b.encode.bytes);
    expect(res).toBe(wstream);
  });

  test('should encode reserved fields', () => {
    const wstream = new BinaryStream();

    const bytes1 = 33;
    const bytes2 = 10;

    const itemType = {
      encode: jest.fn(),
      decode() {}
    };

    itemType.encode.bytes = bytes1;

    const schema = {
      a: {
        encode: jest.fn()
      },
      b: reserved(itemType, 1)
    };

    const object = {
      a: 100
    };

    schema.a.encode.bytes = bytes2;

    encode(object, wstream, schema);

    expect(schema.a.encode).toBeCalled();
    expect(itemType.encode).toBeCalled();
    expect(encode.bytes).toEqual(bytes1 + bytes2);
  });

  test('each field should be a valid type', () => {
    const wstream = new BinaryStream();

    const schema = {
      a: null
    };

    const expectedError = 'Argument `schema` should be a plain object.';

    expect(() => encode({}, wstream, schema)).toThrow(expectedError);
  });

  test('schema should be a plain object', () => {
    const wstream = new BinaryStream();
    const expectedError = 'Argument `schema` should be a plain object.';

    expect(() => encode({}, wstream, 123)).toThrow(expectedError);
    expect(() => encode({}, wstream, '123')).toThrow(expectedError);
    expect(() => encode({}, wstream, /.+/)).toThrow(expectedError);
  });

  test('should encode nexted objects', () => {
    const wstream = new BinaryStream();

    const encodeFn = jest.fn();

    const schema = {
      a: {
        b: {
          encode: encodeFn
        }
      },
      c: {
        encode: encodeFn
      }
    };

    const object = {
      a: {
        b: 100
      },
      c: 100
    };

    encodeFn.bytes = 10;

    encode(object, wstream, schema);
    expect(encodeFn).toHaveBeenCalledTimes(2);
    expect(encode.bytes).toEqual(encodeFn.bytes * 2);
  });

  test('should create stream', () => {
    const schema = {
      a: {
        encode: jest.fn()
      }
    };

    const object = {
      a: 100
    };

    schema.a.encode.bytes = 10;

    const res = encode(object, schema);

    expect(schema.a.encode).toHaveBeenCalledTimes(1);
    expect(encode.bytes).toEqual(schema.a.encode.bytes);
    expect(res).toBeInstanceOf(BinaryStream);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuY29kZS5qcyJdLCJuYW1lcyI6WyJyZXNlcnZlZCIsInJlcXVpcmUiLCJlbmNvZGUiLCJCaW5hcnlTdHJlYW0iLCJkZXNjcmliZSIsInRlc3QiLCJ3c3RyZWFtIiwic2NoZW1hIiwiYSIsImplc3QiLCJmbiIsImIiLCJvYmplY3QiLCJieXRlcyIsInJlcyIsImV4cGVjdCIsInRvSGF2ZUJlZW5DYWxsZWRUaW1lcyIsInRvRXF1YWwiLCJ0b0JlIiwiYnl0ZXMxIiwiYnl0ZXMyIiwiaXRlbVR5cGUiLCJkZWNvZGUiLCJ0b0JlQ2FsbGVkIiwiZXhwZWN0ZWRFcnJvciIsInRvVGhyb3ciLCJlbmNvZGVGbiIsImMiLCJ0b0JlSW5zdGFuY2VPZiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsV0FBV0MsUUFBUSxnQkFBUixDQUFqQjtBQUNBLE1BQU0sRUFBRUMsTUFBRixLQUFhRCxRQUFRLFlBQVIsQ0FBbkI7QUFDQSxNQUFNRSxlQUFlRixRQUFRLG1CQUFSLENBQXJCOztBQUVBRyxTQUFTLFFBQVQsRUFBbUIsTUFBTTtBQUN2QkMsT0FBSyxvQ0FBTCxFQUEyQyxNQUFNO0FBQy9DLFVBQU1DLFVBQVUsSUFBSUgsWUFBSixFQUFoQjs7QUFFQSxVQUFNSSxTQUFTO0FBQ2JDLFNBQUc7QUFDRE4sZ0JBQVFPLEtBQUtDLEVBQUw7QUFEUCxPQURVO0FBSWJDLFNBQUc7QUFDRFQsZ0JBQVFPLEtBQUtDLEVBQUw7QUFEUDtBQUpVLEtBQWY7O0FBU0EsVUFBTUUsU0FBUztBQUNiSixTQUFHLEdBRFU7QUFFYkcsU0FBRztBQUZVLEtBQWY7O0FBS0FKLFdBQU9DLENBQVAsQ0FBU04sTUFBVCxDQUFnQlcsS0FBaEIsR0FBd0IsRUFBeEI7QUFDQU4sV0FBT0ksQ0FBUCxDQUFTVCxNQUFULENBQWdCVyxLQUFoQixHQUF3QixFQUF4Qjs7QUFFQSxVQUFNQyxNQUFNWixPQUFPVSxNQUFQLEVBQWVOLE9BQWYsRUFBd0JDLE1BQXhCLENBQVo7O0FBRUFRLFdBQU9SLE9BQU9D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LEVBQWVOLE9BQWYsRUFBd0JDLE1BQXhCO0FBQ0FRLFdBQU9XLFFBQVAsRUFBaUJWLHFCQUFqQixDQUF1QyxDQUF2QztBQUNBRCxXQUFPYixPQUFPVyxLQUFkLEVBQXFCSSxPQUFyQixDQUE2QlMsU0FBU2IsS0FBVCxHQUFpQixDQUE5QztBQUNELEdBNUJEOztBQThCQVIsT0FBSyxzQkFBTCxFQUE2QixNQUFNO0FBQ2pDLFVBQU1FLFNBQVM7QUFDYkMsU0FBRztBQUNETixnQkFBUU8sS0FBS0MsRUFBTDtBQURQO0FBRFUsS0FBZjs7QUFNQSxVQUFNRSxTQUFTO0FBQ2JKLFNBQUc7QUFEVSxLQUFmOztBQUlBRCxXQUFPQyxDQUFQLENBQVNOLE1BQVQsQ0FBZ0JXLEtBQWhCLEdBQXdCLEVBQXhCOztBQUVBLFVBQU1DLE1BQU1aLE9BQU9VLE1BQVAsRUFBZUwsTUFBZixDQUFaOztBQUVBUSxXQUFPUixPQUFPQyxDQUFQLENBQVNOLE1BQWhCLEVBQXdCYyxxQkFBeEIsQ0FBOEMsQ0FBOUM7QUFDQUQsV0FBT2IsT0FBT1csS0FBZCxFQUFxQkksT0FBckIsQ0FBNkJWLE9BQU9DLENBQVAsQ0FBU04sTUFBVCxDQUFnQlcsS0FBN0M7QUFDQUUsV0FBT0QsR0FBUCxFQUFZYyxjQUFaLENBQTJCekIsWUFBM0I7QUFDRCxHQWxCRDtBQW1CRCxDQXBJRCIsImZpbGUiOiJlbmNvZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJlc2VydmVkID0gcmVxdWlyZSgndHlwZXMvcmVzZXJ2ZWQnKTtcbmNvbnN0IHsgZW5jb2RlIH0gPSByZXF1aXJlKCdsaWIvZW5jb2RlJyk7XG5jb25zdCBCaW5hcnlTdHJlYW0gPSByZXF1aXJlKCdsaWIvYmluYXJ5LXN0cmVhbScpO1xuXG5kZXNjcmliZSgnZW5jb2RlJywgKCkgPT4ge1xuICB0ZXN0KCdzaG91bGQgZW5jb2RlIG9iamVjdHMgdXNpbmcgc2NoZW1hJywgKCkgPT4ge1xuICAgIGNvbnN0IHdzdHJlYW0gPSBuZXcgQmluYXJ5U3RyZWFtKCk7XG5cbiAgICBjb25zdCBzY2hlbWEgPSB7XG4gICAgICBhOiB7XG4gICAgICAgIGVuY29kZTogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIGI6IHtcbiAgICAgICAgZW5jb2RlOiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCBvYmplY3QgPSB7XG4gICAgICBhOiAxMDAsXG4gICAgICBiOiAyMDAsXG4gICAgfTtcblxuICAgIHNjaGVtYS5hLmVuY29kZS5ieXRlcyA9IDEwO1xuICAgIHNjaGVtYS5iLmVuY29kZS5ieXRlcyA9IDMzO1xuXG4gICAgY29uc3QgcmVzID0gZW5jb2RlKG9iamVjdCwgd3N0cmVhbSwgc2NoZW1hKTtcblxuICAgIGV4cGVjdChzY2hlbWEuYS5lbmNvZGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3Qoc2NoZW1hLmIuZW5jb2RlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgZXhwZWN0KGVuY29kZS5ieXRlcykudG9FcXVhbChzY2hlbWEuYS5lbmNvZGUuYnl0ZXMgKyBzY2hlbWEuYi5lbmNvZGUuYnl0ZXMpO1xuICAgIGV4cGVjdChyZXMpLnRvQmUod3N0cmVhbSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBlbmNvZGUgcmVzZXJ2ZWQgZmllbGRzJywgKCkgPT4ge1xuICAgIGNvbnN0IHdzdHJlYW0gPSBuZXcgQmluYXJ5U3RyZWFtKCk7XG5cbiAgICBjb25zdCBieXRlczEgPSAzMztcbiAgICBjb25zdCBieXRlczIgPSAxMDtcblxuICAgIGNvbnN0IGl0ZW1UeXBlID0ge1xuICAgICAgZW5jb2RlOiBqZXN0LmZuKCksXG4gICAgICBkZWNvZGUoKSB7fSxcbiAgICB9O1xuXG4gICAgaXRlbVR5cGUuZW5jb2RlLmJ5dGVzID0gYnl0ZXMxO1xuXG4gICAgY29uc3Qgc2NoZW1hID0ge1xuICAgICAgYToge1xuICAgICAgICBlbmNvZGU6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICBiOiByZXNlcnZlZChpdGVtVHlwZSwgMSksXG4gICAgfTtcblxuICAgIGNvbnN0IG9iamVjdCA9IHtcbiAgICAgIGE6IDEwMCxcbiAgICB9O1xuXG4gICAgc2NoZW1hLmEuZW5jb2RlLmJ5dGVzID0gYnl0ZXMyO1xuXG4gICAgZW5jb2RlKG9iamVjdCwgd3N0cmVhbSwgc2NoZW1hKTtcblxuICAgIGV4cGVjdChzY2hlbWEuYS5lbmNvZGUpLnRvQmVDYWxsZWQoKTtcbiAgICBleHBlY3QoaXRlbVR5cGUuZW5jb2RlKS50b0JlQ2FsbGVkKCk7XG4gICAgZXhwZWN0KGVuY29kZS5ieXRlcykudG9FcXVhbChieXRlczEgKyBieXRlczIpO1xuICB9KTtcblxuICB0ZXN0KCdlYWNoIGZpZWxkIHNob3VsZCBiZSBhIHZhbGlkIHR5cGUnLCAoKSA9PiB7XG4gICAgY29uc3Qgd3N0cmVhbSA9IG5ldyBCaW5hcnlTdHJlYW0oKTtcblxuICAgIGNvbnN0IHNjaGVtYSA9IHtcbiAgICAgIGE6IG51bGwsXG4gICAgfTtcblxuICAgIGNvbnN0IGV4cGVjdGVkRXJyb3IgPSAnQXJndW1lbnQgYHNjaGVtYWAgc2hvdWxkIGJlIGEgcGxhaW4gb2JqZWN0Lic7XG5cbiAgICBleHBlY3QoKCkgPT4gZW5jb2RlKHt9LCB3c3RyZWFtLCBzY2hlbWEpKS50b1Rocm93KGV4cGVjdGVkRXJyb3IpO1xuICB9KTtcblxuICB0ZXN0KCdzY2hlbWEgc2hvdWxkIGJlIGEgcGxhaW4gb2JqZWN0JywgKCkgPT4ge1xuICAgIGNvbnN0IHdzdHJlYW0gPSBuZXcgQmluYXJ5U3RyZWFtKCk7XG4gICAgY29uc3QgZXhwZWN0ZWRFcnJvciA9ICdBcmd1bWVudCBgc2NoZW1hYCBzaG91bGQgYmUgYSBwbGFpbiBvYmplY3QuJztcblxuICAgIGV4cGVjdCgoKSA9PiBlbmNvZGUoe30sIHdzdHJlYW0sIDEyMykpLnRvVGhyb3coZXhwZWN0ZWRFcnJvcik7XG4gICAgZXhwZWN0KCgpID0+IGVuY29kZSh7fSwgd3N0cmVhbSwgJzEyMycpKS50b1Rocm93KGV4cGVjdGVkRXJyb3IpO1xuICAgIGV4cGVjdCgoKSA9PiBlbmNvZGUoe30sIHdzdHJlYW0sIC8uKy8pKS50b1Rocm93KGV4cGVjdGVkRXJyb3IpO1xuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgZW5jb2RlIG5leHRlZCBvYmplY3RzJywgKCkgPT4ge1xuICAgIGNvbnN0IHdzdHJlYW0gPSBuZXcgQmluYXJ5U3RyZWFtKCk7XG5cbiAgICBjb25zdCBlbmNvZGVGbiA9IGplc3QuZm4oKTtcblxuICAgIGNvbnN0IHNjaGVtYSA9IHtcbiAgICAgIGE6IHtcbiAgICAgICAgYjoge1xuICAgICAgICAgIGVuY29kZTogZW5jb2RlRm4sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgYzoge1xuICAgICAgICBlbmNvZGU6IGVuY29kZUZuLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgY29uc3Qgb2JqZWN0ID0ge1xuICAgICAgYToge1xuICAgICAgICBiOiAxMDAsXG4gICAgICB9LFxuICAgICAgYzogMTAwLFxuICAgIH07XG5cbiAgICBlbmNvZGVGbi5ieXRlcyA9IDEwO1xuXG4gICAgZW5jb2RlKG9iamVjdCwgd3N0cmVhbSwgc2NoZW1hKTtcbiAgICBleHBlY3QoZW5jb2RlRm4pLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgICBleHBlY3QoZW5jb2RlLmJ5dGVzKS50b0VxdWFsKGVuY29kZUZuLmJ5dGVzICogMik7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBjcmVhdGUgc3RyZWFtJywgKCkgPT4ge1xuICAgIGNvbnN0IHNjaGVtYSA9IHtcbiAgICAgIGE6IHtcbiAgICAgICAgZW5jb2RlOiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCBvYmplY3QgPSB7XG4gICAgICBhOiAxMDAsXG4gICAgfTtcblxuICAgIHNjaGVtYS5hLmVuY29kZS5ieXRlcyA9IDEwO1xuXG4gICAgY29uc3QgcmVzID0gZW5jb2RlKG9iamVjdCwgc2NoZW1hKTtcblxuICAgIGV4cGVjdChzY2hlbWEuYS5lbmNvZGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QoZW5jb2RlLmJ5dGVzKS50b0VxdWFsKHNjaGVtYS5hLmVuY29kZS5ieXRlcyk7XG4gICAgZXhwZWN0KHJlcykudG9CZUluc3RhbmNlT2YoQmluYXJ5U3RyZWFtKTtcbiAgfSk7XG59KTtcbiJdfQ==