9a75744f2d84e59632285afeaf552cdd
'use strict';

const buffer = require('types/buffer');

describe('buffer', () => {
  describe('argument `length` is number', () => {
    test('encode', () => {
      const writeBuffer = jest.fn();
      const wstream = {
        writeBuffer
      };

      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const type = buffer(length);

      type.encode(buf, wstream);

      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(type.encode.bytes).toBe(length);
    });

    test('should not encode large buffer', () => {
      const length = 2;

      const wstream = {};

      const buf = Buffer.allocUnsafe(length + 1);
      const type = buffer(length);

      expect(() => type.encode(buf, wstream)).toThrow(`Buffer required length ${length} instead of ${buf.length}`);
    });

    test('decode', () => {
      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const readBuffer = jest.fn().mockImplementation(() => buf);
      const rstream = {
        readBuffer
      };

      const type = buffer(length);

      expect(type.decode(rstream)).toBe(buf);
      expect(readBuffer).toHaveBeenCalledTimes(1);
      expect(readBuffer).toBeCalledWith(length);
      expect(type.decode.bytes).toBe(length);
    });

    test('encodingLength', () => {
      const length = 2;

      const type = buffer(length);
      expect(type.encodingLength(Buffer.alloc(0))).toBe(length);
    });
  });

  describe('argument `length` is type', () => {
    test('encode', () => {
      const writeBuffer = jest.fn();
      const wstream = {
        writeBuffer
      };

      const length = 2;
      const lengthBytes = 3;
      const buf = Buffer.allocUnsafe(length);

      const lengthType = {
        decode() {},
        encode: jest.fn().mockImplementation(() => {
          lengthType.encode.bytes = lengthBytes;
        })
      };

      const type = buffer(lengthType);
      type.encode(buf, wstream);

      expect(lengthType.encode).toHaveBeenCalledTimes(1);
      expect(lengthType.encode).toBeCalledWith(length, wstream);
      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(type.encode.bytes).toBe(length + lengthBytes);
    });

    test('decode', () => {
      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const readBuffer = jest.fn().mockImplementation(() => buf);
      const lengthBytes = 5;

      const rstream = {
        readBuffer
      };

      const lengthType = {
        decode: () => length,
        encode() {}
      };

      lengthType.decode.bytes = lengthBytes;

      const type = buffer(lengthType);

      expect(type.decode(rstream)).toBe(buf);
      expect(readBuffer).toHaveBeenCalledTimes(1);
      expect(readBuffer).toBeCalledWith(length);
      expect(type.decode.bytes).toBe(buf.length + lengthBytes);
    });

    test('encodingLength', () => {
      const length = 5;
      const typeLength = 2;
      const buf = Buffer.allocUnsafe(length);

      const lengthType = {
        encode() {},
        decode() {},
        encodingLength() {
          return typeLength;
        }
      };

      const type = buffer(lengthType);

      expect(type.encodingLength(buf)).toBe(typeLength + length);
    });
  });

  describe('argument `length` is function', () => {
    test('decode', () => {
      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const readBuffer = jest.fn().mockImplementation(() => buf);

      const rstream = {
        readBuffer
      };

      const callback = jest.fn().mockImplementation(() => length);
      const type = buffer(callback);

      expect(type.decode(rstream)).toBe(buf);
      expect(readBuffer).toHaveBeenCalledTimes(1);
      expect(readBuffer).toBeCalledWith(length);
      expect(callback).toHaveBeenCalledTimes(1);
      expect(type.decode.bytes).toBe(length);
    });

    test('encode', () => {
      const writeBuffer = jest.fn();

      const wstream = {
        writeBuffer
      };

      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const callback = jest.fn().mockImplementation(() => length);
      const type = buffer(callback);

      type.encode(buf, wstream);

      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(callback).toHaveBeenCalledTimes(1);
      expect(type.encode.bytes).toBe(length);
    });

    test('encodingLength', () => {
      const length = 5;

      const type = buffer(() => length * 2);
      expect(type.encodingLength(Buffer.alloc(length))).toBe(length);
    });
  });

  describe('argument `length` is null', () => {
    test('decode', () => {
      const buf = Buffer.from([1, 2, 3, 4, 5, 0, 5, 6, 7, 8]);
      const length = buf.indexOf(0);
      const expected = buf.slice(0, length);

      const rstream = {
        readBuffer: jest.fn().mockImplementation(size => buf.slice(0, size)),
        indexOf: jest.fn().mockImplementation(byte => buf.indexOf(byte)),
        consume: jest.fn()
      };

      const type = buffer(null);

      expect(type.decode(rstream)).toEqual(expected);
      expect(type.decode.bytes).toEqual(length + 1);
    });

    test('encode', () => {
      const buf = Buffer.from([1, 2, 3, 4, 5]);
      const writeBuffer = jest.fn();
      const writeUInt8 = jest.fn();
      const wstream = {
        writeBuffer,
        writeUInt8
      };

      const type = buffer(null);

      type.encode(buf, wstream);

      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(writeUInt8).toHaveBeenCalledTimes(1);
      expect(writeUInt8).toBeCalledWith(0);
      expect(type.encode.bytes).toBe(buf.length + 1);
    });

    test('encodingLength', () => {
      const buf = Buffer.from([1, 2, 3, 4, 5]);
      const type = buffer(null);

      expect(type.encodingLength(buf)).toBe(buf.length + 1);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJ1ZmZlci5qcyJdLCJuYW1lcyI6WyJidWZmZXIiLCJyZXF1aXJlIiwiZGVzY3JpYmUiLCJ0ZXN0Iiwid3JpdGVCdWZmZXIiLCJqZXN0IiwiZm4iLCJ3c3RyZWFtIiwibGVuZ3RoIiwiYnVmIiwiQnVmZmVyIiwiYWxsb2NVbnNhZmUiLCJ0eXBlIiwiZW5jb2RlIiwiZXhwZWN0IiwidG9IYXZlQmVlbkNhbGxlZFRpbWVzIiwidG9CZUNhbGxlZFdpdGgiLCJieXRlcyIsInRvQmUiLCJ0b1Rocm93IiwicmVhZEJ1ZmZlciIsIm1vY2tJbXBsZW1lbnRhdGlvbiIsInJzdHJlYW0iLCJkZWNvZGUiLCJlbmNvZGluZ0xlbmd0aCIsImFsbG9jIiwibGVuZ3RoQnl0ZXMiLCJsZW5ndGhUeXBlIiwidHlwZUxlbmd0aCIsImNhbGxiYWNrIiwiZnJvbSIsImluZGV4T2YiLCJleHBlY3RlZCIsInNsaWNlIiwic2l6ZSIsImJ5dGUiLCJjb25zdW1lIiwidG9FcXVhbCIsIndyaXRlVUludDgiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLFNBQVNDLFFBQVEsY0FBUixDQUFmOztBQUVBQyxTQUFTLFFBQVQsRUFBbUIsTUFBTTtBQUN2QkEsV0FBUyw2QkFBVCxFQUF3QyxNQUFNO0FBQzVDQyxTQUFLLFFBQUwsRUFBZSxNQUFNO0FBQ25CLFlBQU1DLGNBQWNDLEtBQUtDLEVBQUwsRUFBcEI7QUFDQSxZQUFNQyxVQUFVO0FBQ2RIO0FBRGMsT0FBaEI7O0FBSUEsWUFBTUksU0FBUyxDQUFmO0FBQ0EsWUFBTUMsTUFBTUMsT0FBT0MsV0FBUCxDQUFtQkgsTUFBbkIsQ0FBWjs7QUFFQSxZQUFNSSxPQUFPWixPQUFPUSxNQUFQLENBQWI7O0FBRUFJLFdBQUtDLE1BQUwsQ0FBWUosR0FBWixFQUFpQkYsT0FBakI7O0FBRUFPLGFBQU9WLFdBQVAsRUFBb0JXLHFCQUFwQixDQUEwQyxDQUExQztBQUNBRCxhQUFPVixXQUFQLEVBQW9CWSxjQUFwQixDQUFtQ1AsR0FBbkM7QUFDQUss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RUFBTyxDQUFQLEVBQVUsQ0FBVixFQUFhLENBQWIsQ0FBWixDQUFaO0FBQ0EsWUFBTWxCLE9BQU9aLE9BQU8sSUFBUCxDQUFiOztBQUVBYyxhQUFPRixLQUFLWSxjQUFMLENBQW9CZixHQUFwQixDQUFQLEVBQWlDUyxJQUFqQyxDQUFzQ1QsSUFBSUQsTUFBSixHQUFhLENBQW5EO0FBQ0QsS0FMRDtBQU1ELEdBNUNEO0FBNkNELENBbE9EIiwiZmlsZSI6ImJ1ZmZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgYnVmZmVyID0gcmVxdWlyZSgndHlwZXMvYnVmZmVyJyk7XG5cbmRlc2NyaWJlKCdidWZmZXInLCAoKSA9PiB7XG4gIGRlc2NyaWJlKCdhcmd1bWVudCBgbGVuZ3RoYCBpcyBudW1iZXInLCAoKSA9PiB7XG4gICAgdGVzdCgnZW5jb2RlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgd3JpdGVCdWZmZXIgPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcixcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcihsZW5ndGgpO1xuXG4gICAgICB0eXBlLmVuY29kZShidWYsIHdzdHJlYW0pO1xuXG4gICAgICBleHBlY3Qod3JpdGVCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoYnVmKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9CZShsZW5ndGgpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIG5vdCBlbmNvZGUgbGFyZ2UgYnVmZmVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbGVuZ3RoID0gMjtcblxuICAgICAgY29uc3Qgd3N0cmVhbSA9IHt9O1xuXG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoICsgMSk7XG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aCk7XG5cbiAgICAgIGV4cGVjdCgoKSA9PiB0eXBlLmVuY29kZShidWYsIHdzdHJlYW0pKS50b1Rocm93KFxuICAgICAgICBgQnVmZmVyIHJlcXVpcmVkIGxlbmd0aCAke2xlbmd0aH0gaW5zdGVhZCBvZiAke2J1Zi5sZW5ndGh9YFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2RlY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgcmVhZEJ1ZmZlciA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gYnVmKTtcbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aCk7XG5cbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZShyc3RyZWFtKSkudG9CZShidWYpO1xuICAgICAgZXhwZWN0KHJlYWRCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChyZWFkQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChsZW5ndGgpO1xuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlLmJ5dGVzKS50b0JlKGxlbmd0aCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlbmNvZGluZ0xlbmd0aCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIobGVuZ3RoKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKEJ1ZmZlci5hbGxvYygwKSkpLnRvQmUobGVuZ3RoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2FyZ3VtZW50IGBsZW5ndGhgIGlzIHR5cGUnLCAoKSA9PiB7XG4gICAgdGVzdCgnZW5jb2RlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgd3JpdGVCdWZmZXIgPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcixcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBsZW5ndGhCeXRlcyA9IDM7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgbGVuZ3RoVHlwZSA9IHtcbiAgICAgICAgZGVjb2RlKCkge30sXG4gICAgICAgIGVuY29kZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgICAgbGVuZ3RoVHlwZS5lbmNvZGUuYnl0ZXMgPSBsZW5ndGhCeXRlcztcbiAgICAgICAgfSksXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aFR5cGUpO1xuICAgICAgdHlwZS5lbmNvZGUoYnVmLCB3c3RyZWFtKTtcblxuICAgICAgZXhwZWN0KGxlbmd0aFR5cGUuZW5jb2RlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QobGVuZ3RoVHlwZS5lbmNvZGUpLnRvQmVDYWxsZWRXaXRoKGxlbmd0aCwgd3N0cmVhbSk7XG4gICAgICBleHBlY3Qod3JpdGVCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoYnVmKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9CZShsZW5ndGggKyBsZW5ndGhCeXRlcyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkZWNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsZW5ndGggPSAyO1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCk7XG5cbiAgICAgIGNvbnN0IHJlYWRCdWZmZXIgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IGJ1Zik7XG4gICAgICBjb25zdCBsZW5ndGhCeXRlcyA9IDU7XG5cbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBsZW5ndGhUeXBlID0ge1xuICAgICAgICBkZWNvZGU6ICgpID0+IGxlbmd0aCxcbiAgICAgICAgZW5jb2RlKCkge30sXG4gICAgICB9O1xuXG4gICAgICBsZW5ndGhUeXBlLmRlY29kZS5ieXRlcyA9IGxlbmd0aEJ5dGVzO1xuXG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aFR5cGUpO1xuXG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUocnN0cmVhbSkpLnRvQmUoYnVmKTtcbiAgICAgIGV4cGVjdChyZWFkQnVmZmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QocmVhZEJ1ZmZlcikudG9CZUNhbGxlZFdpdGgobGVuZ3RoKTtcbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZS5ieXRlcykudG9CZShidWYubGVuZ3RoICsgbGVuZ3RoQnl0ZXMpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZW5jb2RpbmdMZW5ndGgnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsZW5ndGggPSA1O1xuICAgICAgY29uc3QgdHlwZUxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgbGVuZ3RoVHlwZSA9IHtcbiAgICAgICAgZW5jb2RlKCkge30sXG4gICAgICAgIGRlY29kZSgpIHt9LFxuICAgICAgICBlbmNvZGluZ0xlbmd0aCgpIHtcbiAgICAgICAgICByZXR1cm4gdHlwZUxlbmd0aDtcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIobGVuZ3RoVHlwZSk7XG5cbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKGJ1ZikpLnRvQmUodHlwZUxlbmd0aCArIGxlbmd0aCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdhcmd1bWVudCBgbGVuZ3RoYCBpcyBmdW5jdGlvbicsICgpID0+IHtcbiAgICB0ZXN0KCdkZWNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsZW5ndGggPSAyO1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCk7XG5cbiAgICAgIGNvbnN0IHJlYWRCdWZmZXIgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IGJ1Zik7XG5cbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbGVuZ3RoKTtcbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIoY2FsbGJhY2spO1xuXG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUocnN0cmVhbSkpLnRvQmUoYnVmKTtcbiAgICAgIGV4cGVjdChyZWFkQnVmZmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QocmVhZEJ1ZmZlcikudG9CZUNhbGxlZFdpdGgobGVuZ3RoKTtcbiAgICAgIGV4cGVjdChjYWxsYmFjaykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlLmJ5dGVzKS50b0JlKGxlbmd0aCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlbmNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCB3cml0ZUJ1ZmZlciA9IGplc3QuZm4oKTtcblxuICAgICAgY29uc3Qgd3N0cmVhbSA9IHtcbiAgICAgICAgd3JpdGVCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBsZW5ndGggPSAyO1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCk7XG5cbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBsZW5ndGgpO1xuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcihjYWxsYmFjayk7XG5cbiAgICAgIHR5cGUuZW5jb2RlKGJ1Ziwgd3N0cmVhbSk7XG5cbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHdyaXRlQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChidWYpO1xuICAgICAgZXhwZWN0KGNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QodHlwZS5lbmNvZGUuYnl0ZXMpLnRvQmUobGVuZ3RoKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2VuY29kaW5nTGVuZ3RoJywgKCkgPT4ge1xuICAgICAgY29uc3QgbGVuZ3RoID0gNTtcblxuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcigoKSA9PiBsZW5ndGggKiAyKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKEJ1ZmZlci5hbGxvYyhsZW5ndGgpKSkudG9CZShsZW5ndGgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnYXJndW1lbnQgYGxlbmd0aGAgaXMgbnVsbCcsICgpID0+IHtcbiAgICB0ZXN0KCdkZWNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuZnJvbShbMSwgMiwgMywgNCwgNSwgMCwgNSwgNiwgNywgOF0pO1xuICAgICAgY29uc3QgbGVuZ3RoID0gYnVmLmluZGV4T2YoMCk7XG4gICAgICBjb25zdCBleHBlY3RlZCA9IGJ1Zi5zbGljZSgwLCBsZW5ndGgpO1xuXG4gICAgICBjb25zdCByc3RyZWFtID0ge1xuICAgICAgICByZWFkQnVmZmVyOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKHNpemUgPT4gYnVmLnNsaWNlKDAsIHNpemUpKSxcbiAgICAgICAgaW5kZXhPZjogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihieXRlID0+IGJ1Zi5pbmRleE9mKGJ5dGUpKSxcbiAgICAgICAgY29uc3VtZTogamVzdC5mbigpLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcihudWxsKTtcblxuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlKHJzdHJlYW0pKS50b0VxdWFsKGV4cGVjdGVkKTtcbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZS5ieXRlcykudG9FcXVhbChsZW5ndGggKyAxKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2VuY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKFsxLCAyLCAzLCA0LCA1XSk7XG4gICAgICBjb25zdCB3cml0ZUJ1ZmZlciA9IGplc3QuZm4oKTtcbiAgICAgIGNvbnN0IHdyaXRlVUludDggPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcixcbiAgICAgICAgd3JpdGVVSW50OCxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIobnVsbCk7XG5cbiAgICAgIHR5cGUuZW5jb2RlKGJ1Ziwgd3N0cmVhbSk7XG5cbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHdyaXRlQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChidWYpO1xuICAgICAgZXhwZWN0KHdyaXRlVUludDgpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdCh3cml0ZVVJbnQ4KS50b0JlQ2FsbGVkV2l0aCgwKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9CZShidWYubGVuZ3RoICsgMSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlbmNvZGluZ0xlbmd0aCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKFsxLCAyLCAzLCA0LCA1XSk7XG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKG51bGwpO1xuXG4gICAgICBleHBlY3QodHlwZS5lbmNvZGluZ0xlbmd0aChidWYpKS50b0JlKGJ1Zi5sZW5ndGggKyAxKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==