8eb51378f95fc5af8986812fc97f4b87
'use strict';

const string = require('types/string');

describe('string', () => {
  describe('null string', () => {
    test('encode', () => {
      const str = 'qwerty';
      const wstream = {
        writeBuffer: jest.fn(),
        writeInt8: jest.fn()
      };

      const type = string(null);

      type.encode(str, wstream);

      expect(type.encode.bytes).toEqual(str.length + 1);
      expect(wstream.writeBuffer).toBeCalledWith(Buffer.from(str, 'ascii'));
      expect(wstream.writeInt8).toBeCalledWith(0);
    });

    test('decode', () => {
      const expectedValue = 'qwerty';
      const expectedLength = expectedValue.length + 1;

      const values = [1, 2, 3, 4, 5, 6, 0];
      const rstream = {
        readBuffer: jest.fn().mockImplementation(() => Buffer.from(`${expectedValue}\0`)),
        length: expectedLength,
        indexOf: jest.fn().mockImplementation(i => values.indexOf(i))
      };

      const type = string(null);

      expect(type.decode(rstream)).toEqual(expectedValue);
      expect(type.decode.bytes).toEqual(expectedLength);
      expect(rstream.readBuffer).toBeCalledWith(expectedLength);
    });

    test('encodingLength', () => {
      const value = 'qwerty';
      const type = string(null);

      expect(type.encodingLength(value)).toEqual(value.length + 1);
    });
  });

  describe('fixed length', () => {
    test('encode', () => {
      const length = 3;
      const wstream = {
        writeBuffer: jest.fn()
      };
      const str = 'qwe';

      const type = string(length);
      type.encode(str, wstream);

      expect(type.encode.bytes).toEqual(length);
      expect(wstream.writeBuffer).toBeCalledWith(Buffer.from(str, 'ascii'));
    });

    test('decode', () => {
      const str = 'qwe';
      const length = 3;
      const rstream = {
        readBuffer: jest.fn().mockImplementation(() => Buffer.from(str))
      };
      const type = string(length);

      expect(type.decode(rstream)).toEqual(str);
      expect(type.decode.bytes).toEqual(length);
    });

    test('encodingLength', () => {
      const length = 3;
      const value = 'qw';
      const type = string(length);

      expect(type.encodingLength(value)).toEqual(length);
    });
  });

  describe('length is type', () => {
    test('encode', () => {
      const writeBuffer = jest.fn();
      const wstream = {
        writeBuffer
      };

      const str = 'qwe';
      const lengthBytes = 3;
      const buf = Buffer.from(str, 'ascii');

      const lengthType = {
        decode() {},
        encode: jest.fn().mockImplementation(() => {
          lengthType.encode.bytes = lengthBytes;
        })
      };

      const type = string(lengthType);
      type.encode(str, wstream);

      expect(lengthType.encode).toHaveBeenCalledTimes(1);
      expect(lengthType.encode).toBeCalledWith(str.length, wstream);
      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(type.encode.bytes).toBe(str.length + lengthBytes);
    });

    test('decode', () => {
      const str = 'qwe';
      const length = 3;
      const lengthBytes = 3;
      const rstream = {
        readBuffer: jest.fn().mockImplementation(() => Buffer.from(str))
      };

      const lengthType = {
        encode() {},
        decode: () => length
      };

      lengthType.decode.bytes = lengthBytes;
      const type = string(lengthType);

      expect(type.decode(rstream)).toEqual(str);
      expect(type.decode.bytes).toEqual(length + lengthBytes);
    });

    test('encodingLength', () => {
      const typeLength = 2;
      const str = 'qwe';

      const lengthType = {
        encode() {},
        decode() {},
        encodingLength() {
          return typeLength;
        }
      };

      const type = string(lengthType);

      expect(type.encodingLength(str)).toBe(typeLength + str.length);
    });
  });

  describe('length is callback', () => {
    test('encode', () => {
      const writeBuffer = jest.fn();
      const wstream = {
        writeBuffer
      };

      const str = 'qwe';
      const lengthBytes = 3;
      const buf = Buffer.from(str, 'ascii');

      const callback = jest.fn().mockImplementation(() => lengthBytes);

      const type = string(callback);
      type.encode(str, wstream);

      expect(callback).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(type.encode.bytes).toBe(str.length);
    });

    test('decode', () => {
      const str = 'qwe';
      const buf = Buffer.from(str);
      const readBuffer = jest.fn().mockImplementation(() => buf);

      const rstream = {
        readBuffer
      };

      const callback = jest.fn().mockImplementation(() => str.length);
      const type = string(callback);

      expect(type.decode(rstream)).toBe(str);
      expect(readBuffer).toHaveBeenCalledTimes(1);
      expect(readBuffer).toBeCalledWith(str.length);
      expect(callback).toHaveBeenCalledTimes(1);
      expect(type.decode.bytes).toBe(str.length);
    });

    test('encodingLength', () => {
      const str = 'qwe';

      const type = string(() => str.length * 2);
      expect(type.encodingLength(str)).toBe(str.length);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0cmluZy5qcyJdLCJuYW1lcyI6WyJzdHJpbmciLCJyZXF1aXJlIiwiZGVzY3JpYmUiLCJ0ZXN0Iiwic3RyIiwid3N0cmVhbSIsIndyaXRlQnVmZmVyIiwiamVzdCIsImZuIiwid3JpdGVJbnQ4IiwidHlwZSIsImVuY29kZSIsImV4cGVjdCIsImJ5dGVzIiwidG9FcXVhbCIsImxlbmd0aCIsInRvQmVDYWxsZWRXaXRoIiwiQnVmZmVyIiwiZnJvbSIsImV4cGVjdGVkVmFsdWUiLCJleHBlY3RlZExlbmd0aCIsInZhbHVlcyIsInJzdHJlYW0iLCJyZWFkQnVmZmVyIiwibW9ja0ltcGxlbWVudGF0aW9uIiwiaW5kZXhPZiIsImkiLCJkZWNvZGUiLCJ2YWx1ZSIsImVuY29kaW5nTGVuZ3RoIiwibGVuZ3RoQnl0ZXMiLCJidWYiLCJsZW5ndGhUeXBlIiwidG9IYXZlQmVlbkNhbGxlZFRpbWVzIiwidG9CZSIsInR5cGVMZW5ndGgiLCJjYWxsYmFjayJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsU0FBU0MsUUFBUSxjQUFSLENBQWY7O0FBRUFDLFNBQVMsUUFBVCxFQUFtQixNQUFNO0FBQ3ZCQSxXQUFTLGFBQVQsRUFBd0IsTUFBTTtBQUM1QkMsU0FBSyxRQUFMLEVBQWUsTUFBTTtBQUNuQixZQUFNQyxNQUFNLFFBQVo7QUFDQSxZQUFNQyxVQUFVO0FBQ2RDLHFCQUFhQyxLQUFLQyxFQUFMLEVBREM7QUFFZEMsbUJBQVdGLEtBQUtDLEVBQUw7QUFGRyxPQUFoQjs7QUFLQSxZQUFNRSxPQUFPVixPQUFPLElBQVAsQ0FBYjs7QUFFQVUsV0FBS0MsTUFBTCxDQUFZUCxHQUFaLEVBQWlCQyxPQUFqQjs7QUFFQU8sYUFBT0YsS0FBS0MsTUFBTCxDQUFZRSxLQUFuQixFQUEwQkMsT0FBMUIsQ0FBa0NWLElBQUlXLE1BQUosR0FBYSxDQUEvQztBQUNBSCxhQUFPUCxRQUFRQyxXQUFmLEVBQTRCVSxjQUE1QixDQUEyQ0MsT0FBT0MsSUFBUCxDQUFZZCxHQUFaLEVB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aUJILHFCQUFqQixDQUF1QyxDQUF2QztBQUNBckIsYUFBT0YsS0FBS2lCLE1BQUwsQ0FBWWQsS0FBbkIsRUFBMEJxQixJQUExQixDQUErQjlCLElBQUlXLE1BQW5DO0FBQ0QsS0FqQkQ7O0FBbUJBWixTQUFLLGdCQUFMLEVBQXVCLE1BQU07QUFDM0IsWUFBTUMsTUFBTSxLQUFaOztBQUVBLFlBQU1NLE9BQU9WLE9BQU8sTUFBTUksSUFBSVcsTUFBSixHQUFhLENBQTFCLENBQWI7QUFDQUgsYUFBT0YsS0FBS21CLGNBQUwsQ0FBb0J6QixHQUFwQixDQUFQLEVBQWlDOEIsSUFBakMsQ0FBc0M5QixJQUFJVyxNQUExQztBQUNELEtBTEQ7QUFNRCxHQS9DRDtBQWdERCxDQXBNRCIsImZpbGUiOiJzdHJpbmcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHN0cmluZyA9IHJlcXVpcmUoJ3R5cGVzL3N0cmluZycpO1xuXG5kZXNjcmliZSgnc3RyaW5nJywgKCkgPT4ge1xuICBkZXNjcmliZSgnbnVsbCBzdHJpbmcnLCAoKSA9PiB7XG4gICAgdGVzdCgnZW5jb2RlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RyID0gJ3F3ZXJ0eSc7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcjogamVzdC5mbigpLFxuICAgICAgICB3cml0ZUludDg6IGplc3QuZm4oKSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBzdHJpbmcobnVsbCk7XG5cbiAgICAgIHR5cGUuZW5jb2RlKHN0ciwgd3N0cmVhbSk7XG5cbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9FcXVhbChzdHIubGVuZ3RoICsgMSk7XG4gICAgICBleHBlY3Qod3N0cmVhbS53cml0ZUJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoQnVmZmVyLmZyb20oc3RyLCAnYXNjaWknKSk7XG4gICAgICBleHBlY3Qod3N0cmVhbS53cml0ZUludDgpLnRvQmVDYWxsZWRXaXRoKDApO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZGVjb2RlJywgKCkgPT4ge1xuICAgICAgY29uc3QgZXhwZWN0ZWRWYWx1ZSA9ICdxd2VydHknO1xuICAgICAgY29uc3QgZXhwZWN0ZWRMZW5ndGggPSBleHBlY3RlZFZhbHVlLmxlbmd0aCArIDE7XG5cbiAgICAgIGNvbnN0IHZhbHVlcyA9IFsxLCAyLCAzLCA0LCA1LCA2LCAwXTtcbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXI6IGplc3RcbiAgICAgICAgICAuZm4oKVxuICAgICAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gQnVmZmVyLmZyb20oYCR7ZXhwZWN0ZWRWYWx1ZX1cXDBgKSksXG4gICAgICAgIGxlbmd0aDogZXhwZWN0ZWRMZW5ndGgsXG4gICAgICAgIGluZGV4T2Y6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oaSA9PiB2YWx1ZXMuaW5kZXhPZihpKSksXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB0eXBlID0gc3RyaW5nKG51bGwpO1xuXG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUocnN0cmVhbSkpLnRvRXF1YWwoZXhwZWN0ZWRWYWx1ZSk7XG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUuYnl0ZXMpLnRvRXF1YWwoZXhwZWN0ZWRMZW5ndGgpO1xuICAgICAgZXhwZWN0KHJzdHJlYW0ucmVhZEJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoZXhwZWN0ZWRMZW5ndGgpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZW5jb2RpbmdMZW5ndGgnLCAoKSA9PiB7XG4gICAgICBjb25zdCB2YWx1ZSA9ICdxd2VydHknO1xuICAgICAgY29uc3QgdHlwZSA9IHN0cmluZyhudWxsKTtcblxuICAgICAgZXhwZWN0KHR5cGUuZW5jb2RpbmdMZW5ndGgodmFsdWUpKS50b0VxdWFsKHZhbHVlLmxlbmd0aCArIDEpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZml4ZWQgbGVuZ3RoJywgKCkgPT4ge1xuICAgIHRlc3QoJ2VuY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGxlbmd0aCA9IDM7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcjogamVzdC5mbigpLFxuICAgICAgfTtcbiAgICAgIGNvbnN0IHN0ciA9ICdxd2UnO1xuXG4gICAgICBjb25zdCB0eXBlID0gc3RyaW5nKGxlbmd0aCk7XG4gICAgICB0eXBlLmVuY29kZShzdHIsIHdzdHJlYW0pO1xuXG4gICAgICBleHBlY3QodHlwZS5lbmNvZGUuYnl0ZXMpLnRvRXF1YWwobGVuZ3RoKTtcbiAgICAgIGV4cGVjdCh3c3RyZWFtLndyaXRlQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChCdWZmZXIuZnJvbShzdHIsICdhc2NpaScpKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2RlY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHN0ciA9ICdxd2UnO1xuICAgICAgY29uc3QgbGVuZ3RoID0gMztcbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXI6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gQnVmZmVyLmZyb20oc3RyKSksXG4gICAgICB9O1xuICAgICAgY29uc3QgdHlwZSA9IHN0cmluZyhsZW5ndGgpO1xuXG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUocnN0cmVhbSkpLnRvRXF1YWwoc3RyKTtcbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZS5ieXRlcykudG9FcXVhbChsZW5ndGgpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZW5jb2RpbmdMZW5ndGgnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsZW5ndGggPSAzO1xuICAgICAgY29uc3QgdmFsdWUgPSAncXcnO1xuICAgICAgY29uc3QgdHlwZSA9IHN0cmluZyhsZW5ndGgpO1xuXG4gICAgICBleHBlY3QodHlwZS5lbmNvZGluZ0xlbmd0aCh2YWx1ZSkpLnRvRXF1YWwobGVuZ3RoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xlbmd0aCBpcyB0eXBlJywgKCkgPT4ge1xuICAgIHRlc3QoJ2VuY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHdyaXRlQnVmZmVyID0gamVzdC5mbigpO1xuICAgICAgY29uc3Qgd3N0cmVhbSA9IHtcbiAgICAgICAgd3JpdGVCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBzdHIgPSAncXdlJztcbiAgICAgIGNvbnN0IGxlbmd0aEJ5dGVzID0gMztcbiAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKHN0ciwgJ2FzY2lpJyk7XG5cbiAgICAgIGNvbnN0IGxlbmd0aFR5cGUgPSB7XG4gICAgICAgIGRlY29kZSgpIHt9LFxuICAgICAgICBlbmNvZGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge1xuICAgICAgICAgIGxlbmd0aFR5cGUuZW5jb2RlLmJ5dGVzID0gbGVuZ3RoQnl0ZXM7XG4gICAgICAgIH0pLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgdHlwZSA9IHN0cmluZyhsZW5ndGhUeXBlKTtcbiAgICAgIHR5cGUuZW5jb2RlKHN0ciwgd3N0cmVhbSk7XG5cbiAgICAgIGV4cGVjdChsZW5ndGhUeXBlLmVuY29kZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KGxlbmd0aFR5cGUuZW5jb2RlKS50b0JlQ2FsbGVkV2l0aChzdHIubGVuZ3RoLCB3c3RyZWFtKTtcbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHdyaXRlQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChidWYpO1xuICAgICAgZXhwZWN0KHR5cGUuZW5jb2RlLmJ5dGVzKS50b0JlKHN0ci5sZW5ndGggKyBsZW5ndGhCeXRlcyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkZWNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzdHIgPSAncXdlJztcbiAgICAgIGNvbnN0IGxlbmd0aCA9IDM7XG4gICAgICBjb25zdCBsZW5ndGhCeXRlcyA9IDM7XG4gICAgICBjb25zdCByc3RyZWFtID0ge1xuICAgICAgICByZWFkQnVmZmVyOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IEJ1ZmZlci5mcm9tKHN0cikpLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgbGVuZ3RoVHlwZSA9IHtcbiAgICAgICAgZW5jb2RlKCkge30sXG4gICAgICAgIGRlY29kZTogKCkgPT4gbGVuZ3RoLFxuICAgICAgfTtcblxuICAgICAgbGVuZ3RoVHlwZS5kZWNvZGUuYnl0ZXMgPSBsZW5ndGhCeXRlcztcbiAgICAgIGNvbnN0IHR5cGUgPSBzdHJpbmcobGVuZ3RoVHlwZSk7XG5cbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZShyc3RyZWFtKSkudG9FcXVhbChzdHIpO1xuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlLmJ5dGVzKS50b0VxdWFsKGxlbmd0aCArIGxlbmd0aEJ5dGVzKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2VuY29kaW5nTGVuZ3RoJywgKCkgPT4ge1xuICAgICAgY29uc3QgdHlwZUxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBzdHIgPSAncXdlJztcblxuICAgICAgY29uc3QgbGVuZ3RoVHlwZSA9IHtcbiAgICAgICAgZW5jb2RlKCkge30sXG4gICAgICAgIGRlY29kZSgpIHt9LFxuICAgICAgICBlbmNvZGluZ0xlbmd0aCgpIHtcbiAgICAgICAgICByZXR1cm4gdHlwZUxlbmd0aDtcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBzdHJpbmcobGVuZ3RoVHlwZSk7XG5cbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKHN0cikpLnRvQmUodHlwZUxlbmd0aCArIHN0ci5sZW5ndGgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbGVuZ3RoIGlzIGNhbGxiYWNrJywgKCkgPT4ge1xuICAgIHRlc3QoJ2VuY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHdyaXRlQnVmZmVyID0gamVzdC5mbigpO1xuICAgICAgY29uc3Qgd3N0cmVhbSA9IHtcbiAgICAgICAgd3JpdGVCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBzdHIgPSAncXdlJztcbiAgICAgIGNvbnN0IGxlbmd0aEJ5dGVzID0gMztcbiAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKHN0ciwgJ2FzY2lpJyk7XG5cbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBsZW5ndGhCeXRlcyk7XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBzdHJpbmcoY2FsbGJhY2spO1xuICAgICAgdHlwZS5lbmNvZGUoc3RyLCB3c3RyZWFtKTtcblxuICAgICAgZXhwZWN0KGNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3Qod3JpdGVCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoYnVmKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9CZShzdHIubGVuZ3RoKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2RlY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHN0ciA9ICdxd2UnO1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmZyb20oc3RyKTtcbiAgICAgIGNvbnN0IHJlYWRCdWZmZXIgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IGJ1Zik7XG5cbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gc3RyLmxlbmd0aCk7XG4gICAgICBjb25zdCB0eXBlID0gc3RyaW5nKGNhbGxiYWNrKTtcblxuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlKHJzdHJlYW0pKS50b0JlKHN0cik7XG4gICAgICBleHBlY3QocmVhZEJ1ZmZlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHJlYWRCdWZmZXIpLnRvQmVDYWxsZWRXaXRoKHN0ci5sZW5ndGgpO1xuICAgICAgZXhwZWN0KGNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUuYnl0ZXMpLnRvQmUoc3RyLmxlbmd0aCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlbmNvZGluZ0xlbmd0aCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHN0ciA9ICdxd2UnO1xuXG4gICAgICBjb25zdCB0eXBlID0gc3RyaW5nKCgpID0+IHN0ci5sZW5ndGggKiAyKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKHN0cikpLnRvQmUoc3RyLmxlbmd0aCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=