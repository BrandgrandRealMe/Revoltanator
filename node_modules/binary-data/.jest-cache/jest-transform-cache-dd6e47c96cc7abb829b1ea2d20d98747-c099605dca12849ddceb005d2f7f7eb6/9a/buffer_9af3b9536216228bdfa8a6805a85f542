61fea60f165299886a61abebc48d277d
'use strict';

const buffer = require('types/buffer');
// const BinaryStream = require('lib/binary-stream');

describe('buffer', () => {
  describe('argument `length` is number', () => {
    test('encode', () => {
      const writeBuffer = jest.fn();
      const wstream = {
        writeBuffer
      };

      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const type = buffer(length);

      type.encode(buf, wstream);

      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(type.encode.bytes).toBe(length);
    });

    test('should not encode large buffer', () => {
      const length = 2;

      const wstream = {};

      const buf = Buffer.allocUnsafe(length + 1);
      const type = buffer(length);

      expect(() => type.encode(buf, wstream)).toThrow(`Buffer required length ${length} instead of ${buf.length}`);
    });

    test('decode', () => {
      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const readBuffer = jest.fn().mockImplementation(() => buf);
      const rstream = {
        readBuffer
      };

      const type = buffer(length);

      expect(type.decode(rstream)).toBe(buf);
      expect(readBuffer).toHaveBeenCalledTimes(1);
      expect(readBuffer).toBeCalledWith(length);
      expect(type.decode.bytes).toBe(length);
    });

    test('encodingLength', () => {
      const length = 2;

      const type = buffer(length);
      expect(type.encodingLength(Buffer.alloc(0))).toBe(length);
    });
  });

  describe('argument `length` is type', () => {
    test('encode', () => {
      const writeBuffer = jest.fn();
      const wstream = {
        writeBuffer
      };

      const length = 2;
      const lengthBytes = 3;
      const buf = Buffer.allocUnsafe(length);

      const lengthType = {
        decode() {},
        encode: jest.fn().mockImplementation(() => {
          lengthType.encode.bytes = lengthBytes;
        })
      };

      const type = buffer(lengthType);
      type.encode(buf, wstream);

      expect(lengthType.encode).toHaveBeenCalledTimes(1);
      expect(lengthType.encode).toBeCalledWith(length, wstream);
      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(type.encode.bytes).toBe(length + lengthBytes);
    });

    test('decode', () => {
      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const readBuffer = jest.fn().mockImplementation(() => buf);
      const lengthBytes = 5;

      const rstream = {
        readBuffer
      };

      const lengthType = {
        decode: () => length,
        encode() {}
      };

      lengthType.decode.bytes = lengthBytes;

      const type = buffer(lengthType);

      expect(type.decode(rstream)).toBe(buf);
      expect(readBuffer).toHaveBeenCalledTimes(1);
      expect(readBuffer).toBeCalledWith(length);
      expect(type.decode.bytes).toBe(buf.length + lengthBytes);
    });

    test('encodingLength', () => {
      const length = 5;
      const typeLength = 2;
      const buf = Buffer.allocUnsafe(length);

      const lengthType = {
        encode() {},
        decode() {},
        encodingLength() {
          return typeLength;
        }
      };

      const type = buffer(lengthType);

      expect(type.encodingLength(buf)).toBe(typeLength + length);
    });
  });

  describe('argument `length` is function', () => {
    test('decode', () => {
      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const readBuffer = jest.fn().mockImplementation(() => buf);

      const rstream = {
        readBuffer
      };

      const callback = jest.fn().mockImplementation(() => length);
      const type = buffer(callback);

      expect(type.decode(rstream)).toBe(buf);
      expect(readBuffer).toHaveBeenCalledTimes(1);
      expect(readBuffer).toBeCalledWith(length);
      expect(callback).toHaveBeenCalledTimes(1);
      expect(type.decode.bytes).toBe(length);
    });

    test('encode', () => {
      const writeBuffer = jest.fn();

      const wstream = {
        writeBuffer
      };

      const length = 2;
      const buf = Buffer.allocUnsafe(length);

      const callback = jest.fn().mockImplementation(() => length);
      const type = buffer(callback);

      type.encode(buf, wstream);

      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(callback).toHaveBeenCalledTimes(1);
      expect(type.encode.bytes).toBe(length);
    });

    test('encodingLength', () => {
      const length = 5;

      const type = buffer(() => length * 2);
      expect(type.encodingLength(Buffer.alloc(length))).toBe(length);
    });
  });

  describe('argument `length` is null', () => {
    test('decode', () => {
      const buf = Buffer.from([1, 2, 3, 4, 5, 0, 5, 6, 7, 8]);
      const length = buf.indexOf(0);
      const expected = buf.slice(0, length);

      const rstream = {
        readBuffer: jest.fn().mockImplementation(size => buf.slice(0, size)),
        indexOf: jest.fn().mockImplementation(byte => buf.indexOf(byte)),
        consume: jest.fn()
      };

      const type = buffer(null);

      expect(type.decode(rstream)).toEqual(expected);
      expect(type.decode.bytes).toEqual(length + 1);
    });

    test('encode', () => {
      const buf = Buffer.from([1, 2, 3, 4, 5]);
      const writeBuffer = jest.fn();
      const writeUInt8 = jest.fn();
      const wstream = {
        writeBuffer,
        writeUInt8
      };

      const type = buffer(null);

      type.encode(buf, wstream);

      expect(writeBuffer).toHaveBeenCalledTimes(1);
      expect(writeBuffer).toBeCalledWith(buf);
      expect(writeUInt8).toHaveBeenCalledTimes(1);
      expect(writeUInt8).toBeCalledWith(0);
      expect(type.encode.bytes).toBe(buf.length + 1);
    });

    test('encodingLength', () => {
      const buf = Buffer.from([1, 2, 3, 4, 5]);
      const type = buffer(null);

      expect(type.encodingLength(buf)).toBe(buf.length + 1);
    });
  });

  // test('should be able to encode BinaryStream', () => {
  //   const buf = new BinaryStream();
  //   const writeBuffer = jest.fn();
  //   const writeUInt8 = jest.fn();
  //   const wstream = {
  //     writeBuffer,
  //     writeUInt8,
  //   };

  //   const type = buffer(null);

  //   type.encode(buf, wstream);

  //   expect(writeBuffer).toHaveBeenCalledTimes(1);
  //   expect(writeBuffer).toBeCalledWith(buf);
  //   expect(writeUInt8).toHaveBeenCalledTimes(1);
  //   expect(writeUInt8).toBeCalledWith(0);
  //   expect(type.encode.bytes).toBe(buf.length + 1);
  // });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJ1ZmZlci5qcyJdLCJuYW1lcyI6WyJidWZmZXIiLCJyZXF1aXJlIiwiZGVzY3JpYmUiLCJ0ZXN0Iiwid3JpdGVCdWZmZXIiLCJqZXN0IiwiZm4iLCJ3c3RyZWFtIiwibGVuZ3RoIiwiYnVmIiwiQnVmZmVyIiwiYWxsb2NVbnNhZmUiLCJ0eXBlIiwiZW5jb2RlIiwiZXhwZWN0IiwidG9IYXZlQmVlbkNhbGxlZFRpbWVzIiwidG9CZUNhbGxlZFdpdGgiLCJieXRlcyIsInRvQmUiLCJ0b1Rocm93IiwicmVhZEJ1ZmZlciIsIm1vY2tJbXBsZW1lbnRhdGlvbiIsInJzdHJlYW0iLCJkZWNvZGUiLCJlbmNvZGluZ0xlbmd0aCIsImFsbG9jIiwibGVuZ3RoQnl0ZXMiLCJsZW5ndGhUeXBlIiwidHlwZUxlbmd0aCIsImNhbGxiYWNrIiwiZnJvbSIsImluZGV4T2YiLCJleHBlY3RlZCIsInNsaWNlIiwic2l6ZSIsImJ5dGUiLCJjb25zdW1lIiwidG9FcXVhbCIsIndyaXRlVUludDgiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLFNBQVNDLFFBQVEsY0FBUixDQUFmO0FBQ0E7O0FBRUFDLFNBQVMsUUFBVCxFQUFtQixNQUFNO0FBQ3ZCQSxXQUFTLDZCQUFULEVBQXdDLE1BQU07QUFDNUNDLFNBQUssUUFBTCxFQUFlLE1BQU07QUFDbkIsWUFBTUMsY0FBY0MsS0FBS0MsRUFBTCxFQUFwQjtBQUNBLFlBQU1DLFVBQVU7QUFDZEg7QUFEYyxPQUFoQjs7QUFJQSxZQUFNSSxTQUFTLENBQWY7QUFDQSxZQUFNQyxNQUFNQyxPQUFPQyxXQUFQLENBQW1CSCxNQUFuQixDQUFaOztBQUVBLFlBQU1JLE9BQU9aLE9BQU9RLE1BQVAsQ0FBYjs7QUFFQUksV0FBS0MsTUFBTCxDQUFZSixHQUFaLEVBQWlCRixPQUFqQjs7QUFFQU8sYUFBT1YsV0FBUCxFQUFvQlcscUJBQXBCLENBQTBDLENBQTFDO0FBQ0FELGFBQU9WLFdBQVAsRUFBb0JZLGNBQXBCLENBQW1DUCxHQUFuQztB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Q0FBSixFQUFPLENBQVAsRUFBVSxDQUFWLEVBQWEsQ0FBYixDQUFaLENBQVo7QUFDQSxZQUFNbEIsT0FBT1osT0FBTyxJQUFQLENBQWI7O0FBRUFjLGFBQU9GLEtBQUtZLGNBQUwsQ0FBb0JmLEdBQXBCLENBQVAsRUFBaUNTLElBQWpDLENBQXNDVCxJQUFJRCxNQUFKLEdBQWEsQ0FBbkQ7QUFDRCxLQUxEO0FBTUQsR0E1Q0Q7O0FBOENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0QsQ0F0UEQiLCJmaWxlIjoiYnVmZmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBidWZmZXIgPSByZXF1aXJlKCd0eXBlcy9idWZmZXInKTtcbi8vIGNvbnN0IEJpbmFyeVN0cmVhbSA9IHJlcXVpcmUoJ2xpYi9iaW5hcnktc3RyZWFtJyk7XG5cbmRlc2NyaWJlKCdidWZmZXInLCAoKSA9PiB7XG4gIGRlc2NyaWJlKCdhcmd1bWVudCBgbGVuZ3RoYCBpcyBudW1iZXInLCAoKSA9PiB7XG4gICAgdGVzdCgnZW5jb2RlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgd3JpdGVCdWZmZXIgPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcixcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcihsZW5ndGgpO1xuXG4gICAgICB0eXBlLmVuY29kZShidWYsIHdzdHJlYW0pO1xuXG4gICAgICBleHBlY3Qod3JpdGVCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoYnVmKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9CZShsZW5ndGgpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIG5vdCBlbmNvZGUgbGFyZ2UgYnVmZmVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbGVuZ3RoID0gMjtcblxuICAgICAgY29uc3Qgd3N0cmVhbSA9IHt9O1xuXG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoICsgMSk7XG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aCk7XG5cbiAgICAgIGV4cGVjdCgoKSA9PiB0eXBlLmVuY29kZShidWYsIHdzdHJlYW0pKS50b1Rocm93KFxuICAgICAgICBgQnVmZmVyIHJlcXVpcmVkIGxlbmd0aCAke2xlbmd0aH0gaW5zdGVhZCBvZiAke2J1Zi5sZW5ndGh9YFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2RlY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgcmVhZEJ1ZmZlciA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gYnVmKTtcbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aCk7XG5cbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZShyc3RyZWFtKSkudG9CZShidWYpO1xuICAgICAgZXhwZWN0KHJlYWRCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChyZWFkQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChsZW5ndGgpO1xuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlLmJ5dGVzKS50b0JlKGxlbmd0aCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlbmNvZGluZ0xlbmd0aCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIobGVuZ3RoKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKEJ1ZmZlci5hbGxvYygwKSkpLnRvQmUobGVuZ3RoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2FyZ3VtZW50IGBsZW5ndGhgIGlzIHR5cGUnLCAoKSA9PiB7XG4gICAgdGVzdCgnZW5jb2RlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgd3JpdGVCdWZmZXIgPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcixcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBsZW5ndGhCeXRlcyA9IDM7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgbGVuZ3RoVHlwZSA9IHtcbiAgICAgICAgZGVjb2RlKCkge30sXG4gICAgICAgIGVuY29kZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgICAgbGVuZ3RoVHlwZS5lbmNvZGUuYnl0ZXMgPSBsZW5ndGhCeXRlcztcbiAgICAgICAgfSksXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aFR5cGUpO1xuICAgICAgdHlwZS5lbmNvZGUoYnVmLCB3c3RyZWFtKTtcblxuICAgICAgZXhwZWN0KGxlbmd0aFR5cGUuZW5jb2RlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QobGVuZ3RoVHlwZS5lbmNvZGUpLnRvQmVDYWxsZWRXaXRoKGxlbmd0aCwgd3N0cmVhbSk7XG4gICAgICBleHBlY3Qod3JpdGVCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoYnVmKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9CZShsZW5ndGggKyBsZW5ndGhCeXRlcyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkZWNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsZW5ndGggPSAyO1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCk7XG5cbiAgICAgIGNvbnN0IHJlYWRCdWZmZXIgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IGJ1Zik7XG4gICAgICBjb25zdCBsZW5ndGhCeXRlcyA9IDU7XG5cbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBsZW5ndGhUeXBlID0ge1xuICAgICAgICBkZWNvZGU6ICgpID0+IGxlbmd0aCxcbiAgICAgICAgZW5jb2RlKCkge30sXG4gICAgICB9O1xuXG4gICAgICBsZW5ndGhUeXBlLmRlY29kZS5ieXRlcyA9IGxlbmd0aEJ5dGVzO1xuXG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKGxlbmd0aFR5cGUpO1xuXG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUocnN0cmVhbSkpLnRvQmUoYnVmKTtcbiAgICAgIGV4cGVjdChyZWFkQnVmZmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QocmVhZEJ1ZmZlcikudG9CZUNhbGxlZFdpdGgobGVuZ3RoKTtcbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZS5ieXRlcykudG9CZShidWYubGVuZ3RoICsgbGVuZ3RoQnl0ZXMpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZW5jb2RpbmdMZW5ndGgnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsZW5ndGggPSA1O1xuICAgICAgY29uc3QgdHlwZUxlbmd0aCA9IDI7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKTtcblxuICAgICAgY29uc3QgbGVuZ3RoVHlwZSA9IHtcbiAgICAgICAgZW5jb2RlKCkge30sXG4gICAgICAgIGRlY29kZSgpIHt9LFxuICAgICAgICBlbmNvZGluZ0xlbmd0aCgpIHtcbiAgICAgICAgICByZXR1cm4gdHlwZUxlbmd0aDtcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIobGVuZ3RoVHlwZSk7XG5cbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKGJ1ZikpLnRvQmUodHlwZUxlbmd0aCArIGxlbmd0aCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdhcmd1bWVudCBgbGVuZ3RoYCBpcyBmdW5jdGlvbicsICgpID0+IHtcbiAgICB0ZXN0KCdkZWNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBsZW5ndGggPSAyO1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCk7XG5cbiAgICAgIGNvbnN0IHJlYWRCdWZmZXIgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IGJ1Zik7XG5cbiAgICAgIGNvbnN0IHJzdHJlYW0gPSB7XG4gICAgICAgIHJlYWRCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbGVuZ3RoKTtcbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIoY2FsbGJhY2spO1xuXG4gICAgICBleHBlY3QodHlwZS5kZWNvZGUocnN0cmVhbSkpLnRvQmUoYnVmKTtcbiAgICAgIGV4cGVjdChyZWFkQnVmZmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QocmVhZEJ1ZmZlcikudG9CZUNhbGxlZFdpdGgobGVuZ3RoKTtcbiAgICAgIGV4cGVjdChjYWxsYmFjaykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlLmJ5dGVzKS50b0JlKGxlbmd0aCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlbmNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCB3cml0ZUJ1ZmZlciA9IGplc3QuZm4oKTtcblxuICAgICAgY29uc3Qgd3N0cmVhbSA9IHtcbiAgICAgICAgd3JpdGVCdWZmZXIsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBsZW5ndGggPSAyO1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCk7XG5cbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBsZW5ndGgpO1xuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcihjYWxsYmFjayk7XG5cbiAgICAgIHR5cGUuZW5jb2RlKGJ1Ziwgd3N0cmVhbSk7XG5cbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHdyaXRlQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChidWYpO1xuICAgICAgZXhwZWN0KGNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICBleHBlY3QodHlwZS5lbmNvZGUuYnl0ZXMpLnRvQmUobGVuZ3RoKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2VuY29kaW5nTGVuZ3RoJywgKCkgPT4ge1xuICAgICAgY29uc3QgbGVuZ3RoID0gNTtcblxuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcigoKSA9PiBsZW5ndGggKiAyKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kaW5nTGVuZ3RoKEJ1ZmZlci5hbGxvYyhsZW5ndGgpKSkudG9CZShsZW5ndGgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnYXJndW1lbnQgYGxlbmd0aGAgaXMgbnVsbCcsICgpID0+IHtcbiAgICB0ZXN0KCdkZWNvZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBidWYgPSBCdWZmZXIuZnJvbShbMSwgMiwgMywgNCwgNSwgMCwgNSwgNiwgNywgOF0pO1xuICAgICAgY29uc3QgbGVuZ3RoID0gYnVmLmluZGV4T2YoMCk7XG4gICAgICBjb25zdCBleHBlY3RlZCA9IGJ1Zi5zbGljZSgwLCBsZW5ndGgpO1xuXG4gICAgICBjb25zdCByc3RyZWFtID0ge1xuICAgICAgICByZWFkQnVmZmVyOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKHNpemUgPT4gYnVmLnNsaWNlKDAsIHNpemUpKSxcbiAgICAgICAgaW5kZXhPZjogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihieXRlID0+IGJ1Zi5pbmRleE9mKGJ5dGUpKSxcbiAgICAgICAgY29uc3VtZTogamVzdC5mbigpLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgdHlwZSA9IGJ1ZmZlcihudWxsKTtcblxuICAgICAgZXhwZWN0KHR5cGUuZGVjb2RlKHJzdHJlYW0pKS50b0VxdWFsKGV4cGVjdGVkKTtcbiAgICAgIGV4cGVjdCh0eXBlLmRlY29kZS5ieXRlcykudG9FcXVhbChsZW5ndGggKyAxKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2VuY29kZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKFsxLCAyLCAzLCA0LCA1XSk7XG4gICAgICBjb25zdCB3cml0ZUJ1ZmZlciA9IGplc3QuZm4oKTtcbiAgICAgIGNvbnN0IHdyaXRlVUludDggPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCB3c3RyZWFtID0ge1xuICAgICAgICB3cml0ZUJ1ZmZlcixcbiAgICAgICAgd3JpdGVVSW50OCxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBidWZmZXIobnVsbCk7XG5cbiAgICAgIHR5cGUuZW5jb2RlKGJ1Ziwgd3N0cmVhbSk7XG5cbiAgICAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KHdyaXRlQnVmZmVyKS50b0JlQ2FsbGVkV2l0aChidWYpO1xuICAgICAgZXhwZWN0KHdyaXRlVUludDgpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdCh3cml0ZVVJbnQ4KS50b0JlQ2FsbGVkV2l0aCgwKTtcbiAgICAgIGV4cGVjdCh0eXBlLmVuY29kZS5ieXRlcykudG9CZShidWYubGVuZ3RoICsgMSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdlbmNvZGluZ0xlbmd0aCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGJ1ZiA9IEJ1ZmZlci5mcm9tKFsxLCAyLCAzLCA0LCA1XSk7XG4gICAgICBjb25zdCB0eXBlID0gYnVmZmVyKG51bGwpO1xuXG4gICAgICBleHBlY3QodHlwZS5lbmNvZGluZ0xlbmd0aChidWYpKS50b0JlKGJ1Zi5sZW5ndGggKyAxKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgLy8gdGVzdCgnc2hvdWxkIGJlIGFibGUgdG8gZW5jb2RlIEJpbmFyeVN0cmVhbScsICgpID0+IHtcbiAgLy8gICBjb25zdCBidWYgPSBuZXcgQmluYXJ5U3RyZWFtKCk7XG4gIC8vICAgY29uc3Qgd3JpdGVCdWZmZXIgPSBqZXN0LmZuKCk7XG4gIC8vICAgY29uc3Qgd3JpdGVVSW50OCA9IGplc3QuZm4oKTtcbiAgLy8gICBjb25zdCB3c3RyZWFtID0ge1xuICAvLyAgICAgd3JpdGVCdWZmZXIsXG4gIC8vICAgICB3cml0ZVVJbnQ4LFxuICAvLyAgIH07XG5cbiAgLy8gICBjb25zdCB0eXBlID0gYnVmZmVyKG51bGwpO1xuXG4gIC8vICAgdHlwZS5lbmNvZGUoYnVmLCB3c3RyZWFtKTtcblxuICAvLyAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAvLyAgIGV4cGVjdCh3cml0ZUJ1ZmZlcikudG9CZUNhbGxlZFdpdGgoYnVmKTtcbiAgLy8gICBleHBlY3Qod3JpdGVVSW50OCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAvLyAgIGV4cGVjdCh3cml0ZVVJbnQ4KS50b0JlQ2FsbGVkV2l0aCgwKTtcbiAgLy8gICBleHBlY3QodHlwZS5lbmNvZGUuYnl0ZXMpLnRvQmUoYnVmLmxlbmd0aCArIDEpO1xuICAvLyB9KTtcbn0pO1xuIl19