{"version":3,"sources":["index.js"],"names":["BinaryStream","require","array","buffer","bool","reserved","string","numbers","when","select","encode","decode","encodingLength","Transaction","NotEnoughDataError","types","type","Object","keys","kschema","Symbol","createEncodeStream","schema","stream","readableObjectMode","writableObjectMode","transform","transformEncode","createDecodeStream","bufOrSchema","isBuffer","Buffer","transformDecode","append","chunk","encoding","cb","buf","slice","consume","length","error","transaction","data","commit","push","module","exports","createEncode","createDecode"],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\n\nconst BinaryStream = require('lib/binary-stream');\nconst array = require('types/array');\nconst buffer = require('types/buffer');\nconst bool = require('types/bool');\nconst reserved = require('types/reserved');\nconst string = require('types/string');\nconst numbers = require('types/numbers');\nconst when = require('types/when');\nconst select = require('types/select');\nconst { encode } = require('lib/encode');\nconst { decode } = require('lib/decode');\nconst { encodingLength } = require('lib/encoding-length');\nconst Transaction = require('lib/transaction');\nconst NotEnoughDataError = require('lib/not-enough-data-error');\n\nconst types = {\n  array,\n  bool,\n  buffer,\n  reserved,\n  string,\n  when,\n  select,\n};\n\nfor (const type of Object.keys(numbers)) {\n  types[type] = numbers[type]; // eslint-disable-line security/detect-object-injection\n}\n\nconst kschema = Symbol('schema');\n\n/**\n * Create transform stream to encode objects into Buffer.\n * @param {Object} [schema]\n * @returns {EncodeStream}\n */\nfunction createEncodeStream(schema) {\n  const stream = new BinaryStream({\n    readableObjectMode: false,\n    writableObjectMode: true,\n    transform: transformEncode,\n  });\n\n  stream[kschema] = schema;\n  return stream;\n}\n\n/**\n * Create transform stream to decode binary data into object.\n * @param {Buffer|Object} [bufOrSchema]\n * @returns {DecodeStream}\n */\nfunction createDecodeStream(bufOrSchema) {\n  let schema = null;\n  const isBuffer = Buffer.isBuffer(bufOrSchema);\n\n  if (!isBuffer) {\n    schema = bufOrSchema;\n  }\n\n  const stream = new BinaryStream({\n    transform: transformDecode,\n    readableObjectMode: true,\n    writableObjectMode: false,\n  });\n\n  stream[kschema] = schema;\n\n  if (isBuffer) {\n    stream.append(bufOrSchema);\n  }\n\n  return stream;\n}\n\n/**\n * The `transform` function for transform stream.\n * @param {*} chunk Any valid js data type.\n * @param {string} encoding\n * @param {Function} cb\n */\nfunction transformEncode(chunk, encoding, cb) {\n  try {\n    encode(chunk, this[kschema], this);\n\n    const buf = this.slice();\n    this.consume(buf.length);\n\n    cb(null, buf);\n  } catch (error) {\n    cb(error);\n  }\n}\n\n/**\n * The `transform` function for transform stream.\n * @param {*} chunk Any valid js data type.\n * @param {string} encoding\n * @param {Function} cb\n */\nfunction transformDecode(chunk, encoding, cb) {\n  this.append(chunk);\n\n  try {\n    while (this.length > 0) {\n      const transaction = new Transaction(this);\n      const data = decode(transaction, this[kschema]);\n\n      transaction.commit();\n      this.push(data);\n    }\n\n    cb();\n  } catch (error) {\n    if (error instanceof NotEnoughDataError) {\n      cb();\n    } else {\n      cb(error);\n    }\n  }\n}\n\nmodule.exports = {\n  /* Main api */\n  createEncodeStream,\n  createDecodeStream,\n  encode,\n  decode,\n  encodingLength,\n\n  /* aliases */\n  createEncode: createEncodeStream,\n  createDecode: createDecodeStream,\n\n  /* Data types */\n  types,\n\n  /* Re-export utils */\n  BinaryStream,\n  NotEnoughDataError,\n};\n"]}