{"version":3,"file":"ice.js","sourceRoot":"","sources":["../../../../src/transport/ice.ts"],"names":[],"mappings":"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","sourcesContent":["import Event from \"rx.mini\";\n\nimport { Candidate, Connection, IceOptions } from \"../../../ice/src\";\nimport { candidateFromSdp, candidateToSdp } from \"../sdp\";\n\nexport class RTCIceTransport {\n  connection = this.gather.connection;\n  state: RTCIceConnectionState = \"new\";\n\n  readonly onStateChange = new Event<[RTCIceConnectionState]>();\n\n  private waitStart?: Event<[]>;\n\n  constructor(private gather: RTCIceGatherer) {\n    this.connection.stateChanged.subscribe((state) => {\n      this.setState(state);\n    });\n  }\n\n  get iceGather() {\n    return this.gather;\n  }\n\n  get role() {\n    if (this.connection.iceControlling) return \"controlling\";\n    else return \"controlled\";\n  }\n\n  private setState(state: RTCIceConnectionState) {\n    if (state !== this.state) {\n      this.state = state;\n\n      if (this.onStateChange.ended) return;\n\n      if (state === \"closed\") {\n        this.onStateChange.execute(state);\n        this.onStateChange.complete();\n      } else {\n        this.onStateChange.execute(state);\n      }\n    }\n  }\n\n  addRemoteCandidate = async (candidate?: IceCandidate) => {\n    if (!this.connection.remoteCandidatesEnd) {\n      if (!candidate) {\n        await this.connection.addRemoteCandidate(undefined);\n      } else {\n        await this.connection.addRemoteCandidate(candidateToIce(candidate));\n      }\n    }\n  };\n\n  setRemoteParams(remoteParameters: RTCIceParameters) {\n    this.connection.remoteIsLite = remoteParameters.iceLite;\n    this.connection.remoteUsername = remoteParameters.usernameFragment;\n    this.connection.remotePassword = remoteParameters.password;\n  }\n\n  async start() {\n    if (this.state === \"closed\") throw new Error(\"RTCIceTransport is closed\");\n    if (!this.connection.remotePassword || !this.connection.remoteUsername)\n      throw new Error(\"remoteParams missing\");\n\n    if (this.waitStart) await this.waitStart.asPromise();\n    this.waitStart = new Event();\n\n    this.setState(\"checking\");\n\n    try {\n      await this.connection.connect();\n    } catch (error) {\n      this.setState(\"failed\");\n      throw new Error(error);\n    }\n\n    this.waitStart.complete();\n  }\n\n  async stop() {\n    if (this.state !== \"closed\") {\n      this.setState(\"closed\");\n      await this.connection.close();\n    }\n  }\n}\n\nexport const IceTransportStates = [\n  \"new\",\n  \"checking\",\n  \"connected\",\n  \"completed\",\n  \"disconnected\",\n  \"failed\",\n  \"closed\",\n] as const;\nexport type RTCIceConnectionState = typeof IceTransportStates[number];\n\nexport const IceGathererStates = [\"new\", \"gathering\", \"complete\"] as const;\nexport type IceGathererState = typeof IceGathererStates[number];\n\nexport class RTCIceGatherer {\n  onIceCandidate: (candidate: IceCandidate) => void = () => {};\n  gatheringState: IceGathererState = \"new\";\n\n  readonly onGatheringStateChange = new Event<[IceGathererState]>();\n  readonly connection = new Connection(false, this.options);\n\n  constructor(private options: Partial<IceOptions> = {}) {}\n\n  async gather() {\n    if (this.gatheringState === \"new\") {\n      this.setState(\"gathering\");\n      await this.connection.gatherCandidates((candidate) =>\n        this.onIceCandidate(candidateFromIce(candidate))\n      );\n      this.setState(\"complete\");\n    }\n  }\n\n  get localCandidates() {\n    return this.connection.localCandidates.map(candidateFromIce);\n  }\n\n  get localParameters() {\n    const params = new RTCIceParameters({\n      usernameFragment: this.connection.localUserName,\n      password: this.connection.localPassword,\n    });\n\n    return params;\n  }\n\n  private setState(state: IceGathererState) {\n    if (state !== this.gatheringState) {\n      this.gatheringState = state;\n      this.onGatheringStateChange.execute(state);\n    }\n  }\n}\n\nexport function candidateFromIce(c: Candidate) {\n  const candidate = new IceCandidate(\n    c.component,\n    c.foundation,\n    c.host,\n    c.port,\n    c.priority,\n    c.transport,\n    c.type\n  );\n  candidate.relatedAddress = c.relatedAddress;\n  candidate.relatedPort = c.relatedPort;\n  candidate.tcpType = c.tcptype;\n  return candidate;\n}\n\nexport function candidateToIce(x: IceCandidate) {\n  return new Candidate(\n    x.foundation,\n    x.component,\n    x.protocol,\n    x.priority,\n    x.ip,\n    x.port,\n    x.type,\n    x.relatedAddress,\n    x.relatedPort,\n    x.tcpType\n  );\n}\n\nexport type RTCIceCandidate = {\n  candidate: string;\n  sdpMid: string;\n  sdpMLineIndex: number;\n};\n\nexport class IceCandidate {\n  // \"\"\"\n  // The :class:`RTCIceCandidate` interface represents a candidate Interactive\n  // Connectivity Establishment (ICE) configuration which may be used to\n  // establish an RTCPeerConnection.\n  // \"\"\"\n  public relatedAddress?: string;\n  public relatedPort?: number;\n  public sdpMid?: string;\n  public sdpMLineIndex?: number;\n  public tcpType?: string;\n\n  constructor(\n    public component: number,\n    public foundation: string,\n    public ip: string,\n    public port: number,\n    public priority: number,\n    public protocol: string,\n    public type: string\n  ) {}\n\n  toJSON(): RTCIceCandidate {\n    return {\n      candidate: candidateToSdp(this),\n      sdpMLineIndex: this.sdpMLineIndex!,\n      sdpMid: this.sdpMid!,\n    };\n  }\n\n  static fromJSON(data: RTCIceCandidate) {\n    try {\n      const candidate = candidateFromSdp(data.candidate);\n      candidate.sdpMLineIndex = data.sdpMLineIndex;\n      candidate.sdpMid = data.sdpMid;\n      return candidate;\n    } catch (error) {}\n  }\n}\n\nexport class RTCIceParameters {\n  iceLite: boolean = false;\n  usernameFragment!: string;\n  password!: string;\n\n  constructor(props: Partial<RTCIceParameters> = {}) {\n    Object.assign(this, props);\n  }\n}\n"]}