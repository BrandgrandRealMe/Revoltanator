{"version":3,"file":"flight5.js","sourceRoot":"","sources":["../../../../../../dtls/src/flight/client/flight5.ts"],"names":[],"mappings":"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","sourcesContent":["import debug from \"debug\";\n\nimport { SignatureAlgorithm, SignatureScheme } from \"../../cipher/const\";\nimport { createCipher } from \"../../cipher/create\";\nimport { generateKeyPair } from \"../../cipher/namedCurve\";\nimport {\n  prfExtendedMasterSecret,\n  prfMasterSecret,\n  prfPreMasterSecret,\n} from \"../../cipher/prf\";\nimport { CipherContext } from \"../../context/cipher\";\nimport { DtlsContext } from \"../../context/dtls\";\nimport { Profile, SrtpContext } from \"../../context/srtp\";\nimport { TransportContext } from \"../../context/transport\";\nimport { HandshakeType } from \"../../handshake/const\";\nimport { ExtendedMasterSecret } from \"../../handshake/extensions/extendedMasterSecret\";\nimport { RenegotiationIndication } from \"../../handshake/extensions/renegotiationIndication\";\nimport { UseSRTP } from \"../../handshake/extensions/useSrtp\";\nimport { Certificate } from \"../../handshake/message/certificate\";\nimport { ChangeCipherSpec } from \"../../handshake/message/changeCipherSpec\";\nimport { CertificateVerify } from \"../../handshake/message/client/certificateVerify\";\nimport { ClientKeyExchange } from \"../../handshake/message/client/keyExchange\";\nimport { Finished } from \"../../handshake/message/finished\";\nimport { ServerCertificateRequest } from \"../../handshake/message/server/certificateRequest\";\nimport { ServerHello } from \"../../handshake/message/server/hello\";\nimport { ServerHelloDone } from \"../../handshake/message/server/helloDone\";\nimport { ServerKeyExchange } from \"../../handshake/message/server/keyExchange\";\nimport { DtlsRandom } from \"../../handshake/random\";\nimport { dumpBuffer } from \"../../helper\";\nimport { createPlaintext } from \"../../record/builder\";\nimport { ContentType } from \"../../record/const\";\nimport { FragmentedHandshake } from \"../../record/message/fragment\";\nimport { Flight } from \"../flight\";\n\nconst log = debug(\n  \"werift-dtls : packages/dtls/src/flight/client/flight5.ts : log\"\n);\n\nexport class Flight5 extends Flight {\n  constructor(\n    udp: TransportContext,\n    dtls: DtlsContext,\n    private cipher: CipherContext,\n    private srtp: SrtpContext\n  ) {\n    super(udp, dtls, 5, 7);\n  }\n\n  handleHandshake(handshake: FragmentedHandshake) {\n    this.dtls.bufferHandshakeCache([handshake], false, 4);\n    const message = (() => {\n      switch (handshake.msg_type) {\n        case HandshakeType.server_hello_2:\n          return ServerHello.deSerialize(handshake.fragment);\n        case HandshakeType.certificate_11:\n          return Certificate.deSerialize(handshake.fragment);\n        case HandshakeType.server_key_exchange_12:\n          return ServerKeyExchange.deSerialize(handshake.fragment);\n        case HandshakeType.certificate_request_13:\n          return ServerCertificateRequest.deSerialize(handshake.fragment);\n        case HandshakeType.server_hello_done_14:\n          return ServerHelloDone.deSerialize(handshake.fragment);\n      }\n    })();\n\n    if (message) {\n      handlers[message.msgType]({\n        dtls: this.dtls,\n        cipher: this.cipher,\n        srtp: this.srtp,\n      })(message);\n    }\n  }\n\n  async exec() {\n    if (this.dtls.flight === 5) {\n      log(this.dtls.sessionId, \"flight5 twice\");\n      this.send(this.dtls.lastMessage);\n      return;\n    }\n    this.dtls.flight = 5;\n\n    const needCertificate = this.dtls.requestedCertificateTypes.length > 0;\n    log(this.dtls.sessionId, \"send flight5\", needCertificate);\n\n    const messages = [\n      needCertificate && this.sendCertificate(),\n      this.sendClientKeyExchange(),\n      needCertificate && this.sendCertificateVerify(),\n      this.sendChangeCipherSpec(),\n      this.sendFinished(),\n    ].filter((v) => v) as Buffer[];\n\n    this.dtls.lastMessage = messages;\n    await this.transmit(messages);\n  }\n\n  sendCertificate() {\n    const certificate = new Certificate([Buffer.from(this.cipher.localCert)]);\n\n    const packets = this.createPacket([certificate]);\n\n    const buf = Buffer.concat(packets.map((v) => v.serialize()));\n    return buf;\n  }\n\n  sendClientKeyExchange() {\n    if (!this.cipher.localKeyPair) throw new Error();\n\n    const clientKeyExchange = new ClientKeyExchange(\n      this.cipher.localKeyPair.publicKey\n    );\n    const packets = this.createPacket([clientKeyExchange]);\n    const buf = Buffer.concat(packets.map((v) => v.serialize()));\n\n    const localKeyPair = this.cipher.localKeyPair;\n    const remoteKeyPair = this.cipher.remoteKeyPair;\n\n    if (!remoteKeyPair.publicKey) throw new Error(\"not exist\");\n\n    const preMasterSecret = prfPreMasterSecret(\n      remoteKeyPair.publicKey,\n      localKeyPair.privateKey,\n      localKeyPair.curve\n    );\n\n    log(\n      this.dtls.sessionId,\n      \"extendedMasterSecret\",\n      this.dtls.options.extendedMasterSecret,\n      this.dtls.remoteExtendedMasterSecret\n    );\n\n    const handshakes = Buffer.concat(\n      this.dtls.sortedHandshakeCache.map((v) => v.serialize())\n    );\n    this.cipher.masterSecret =\n      this.dtls.options.extendedMasterSecret &&\n      this.dtls.remoteExtendedMasterSecret\n        ? prfExtendedMasterSecret(preMasterSecret, handshakes)\n        : prfMasterSecret(\n            preMasterSecret,\n            this.cipher.localRandom.serialize(),\n            this.cipher.remoteRandom.serialize()\n          );\n\n    this.cipher.cipher = createCipher(this.cipher.cipherSuite);\n    this.cipher.cipher.init(\n      this.cipher.masterSecret,\n      this.cipher.remoteRandom.serialize(),\n      this.cipher.localRandom.serialize()\n    );\n    log(this.dtls.sessionId, \"cipher\", this.cipher.cipher.summary);\n\n    return buf;\n  }\n\n  sendCertificateVerify() {\n    const cache = Buffer.concat(\n      this.dtls.sortedHandshakeCache.map((v) => v.serialize())\n    );\n    const signed = this.cipher.signatureData(cache, \"sha256\");\n    const signatureScheme = (() => {\n      switch (this.cipher.signatureHashAlgorithm?.signature) {\n        case SignatureAlgorithm.ecdsa:\n          return SignatureScheme.ecdsa_secp256r1_sha256;\n        case SignatureAlgorithm.rsa:\n          return SignatureScheme.rsa_pkcs1_sha256;\n      }\n    })();\n    if (!signatureScheme) throw new Error();\n    log(\n      this.dtls.sessionId,\n      \"signatureScheme\",\n      this.cipher.signatureHashAlgorithm?.signature,\n      signatureScheme\n    );\n\n    const certificateVerify = new CertificateVerify(signatureScheme, signed);\n    const packets = this.createPacket([certificateVerify]);\n    const buf = Buffer.concat(packets.map((v) => v.serialize()));\n    return buf;\n  }\n\n  sendChangeCipherSpec() {\n    const changeCipherSpec = ChangeCipherSpec.createEmpty().serialize();\n    const packets = createPlaintext(this.dtls)(\n      [{ type: ContentType.changeCipherSpec, fragment: changeCipherSpec }],\n      ++this.dtls.recordSequenceNumber\n    );\n    const buf = Buffer.concat(packets.map((v) => v.serialize()));\n    return buf;\n  }\n\n  sendFinished() {\n    const cache = Buffer.concat(\n      this.dtls.sortedHandshakeCache.map((v) => v.serialize())\n    );\n    const localVerifyData = this.cipher.verifyData(cache);\n\n    const finish = new Finished(localVerifyData);\n    this.dtls.epoch = 1;\n    const [packet] = this.createPacket([finish]);\n    log(\n      this.dtls.sessionId,\n      \"raw finish packet\",\n      packet.summary,\n      this.dtls.sortedHandshakeCache.map((h) => h.summary)\n    );\n\n    this.dtls.recordSequenceNumber = 0;\n\n    const buf = this.cipher.encryptPacket(packet).serialize();\n    log(\n      this.dtls.sessionId,\n      \"finished\",\n      dumpBuffer(buf),\n      this.cipher.cipher.summary\n    );\n    return buf;\n  }\n}\n\nconst handlers: {\n  [key: number]: (contexts: {\n    dtls: DtlsContext;\n    cipher: CipherContext;\n    srtp: SrtpContext;\n  }) => (message: any) => void;\n} = {};\n\nhandlers[HandshakeType.server_hello_2] =\n  ({ cipher, srtp, dtls }) =>\n  (message: ServerHello) => {\n    log(dtls.sessionId, \"serverHello\", message.cipherSuite);\n    cipher.remoteRandom = DtlsRandom.from(message.random);\n    cipher.cipherSuite = message.cipherSuite;\n    log(dtls.sessionId, \"selected cipherSuite\", cipher.cipherSuite);\n\n    if (message.extensions) {\n      message.extensions.forEach((extension) => {\n        switch (extension.type) {\n          case UseSRTP.type:\n            const useSrtp = UseSRTP.fromData(extension.data);\n            const profile = SrtpContext.findMatchingSRTPProfile(\n              useSrtp.profiles as Profile[],\n              dtls.options.srtpProfiles || []\n            );\n            log(dtls.sessionId, \"selected srtp profile\", profile);\n            if (profile == undefined) return;\n            srtp.srtpProfile = profile;\n            break;\n          case ExtendedMasterSecret.type:\n            dtls.remoteExtendedMasterSecret = true;\n            break;\n          case RenegotiationIndication.type:\n            log(dtls.sessionId, \"RenegotiationIndication\");\n            break;\n        }\n      });\n    }\n  };\n\nhandlers[HandshakeType.certificate_11] =\n  ({ cipher, dtls }) =>\n  (message: Certificate) => {\n    log(dtls.sessionId, \"handshake certificate\", message);\n    cipher.remoteCertificate = message.certificateList[0];\n  };\n\nhandlers[HandshakeType.server_key_exchange_12] =\n  ({ cipher, dtls }) =>\n  (message: ServerKeyExchange) => {\n    if (!cipher.localRandom || !cipher.remoteRandom) throw new Error();\n    log(dtls.sessionId, \"ServerKeyExchange\", message);\n\n    log(dtls.sessionId, \"selected curve\", message.namedCurve);\n    cipher.remoteKeyPair = {\n      curve: message.namedCurve,\n      publicKey: message.publicKey,\n    };\n    cipher.localKeyPair = generateKeyPair(message.namedCurve);\n  };\n\nhandlers[HandshakeType.certificate_request_13] =\n  ({ dtls }) =>\n  (message: ServerCertificateRequest) => {\n    log(dtls.sessionId, \"certificate_request\", message);\n    dtls.requestedCertificateTypes = message.certificateTypes;\n    dtls.requestedSignatureAlgorithms = message.signatures;\n  };\n\nhandlers[HandshakeType.server_hello_done_14] =\n  ({ dtls }) =>\n  (msg) => {\n    log(dtls.sessionId, \"server_hello_done\", msg);\n  };\n"]}